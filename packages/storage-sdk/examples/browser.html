<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@visulima/upload-client Browser Example</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: border-color 0.3s;
        }
        .upload-area.dragover {
            border-color: #007acc;
            background-color: #f0f8ff;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #007acc;
            width: 0%;
            transition: width 0.3s;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #005aa3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .file-list {
            margin-top: 20px;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>@visulima/upload-client Browser Example</h1>

    <div class="upload-area" id="uploadArea">
        <p>Drag and drop files here or click to select</p>
        <input type="file" id="fileInput" multiple style="display: none;">
        <button onclick="document.getElementById('fileInput').click()">Select Files</button>
    </div>

    <div id="uploadContainer"></div>

    <div class="file-list" id="fileList">
        <h3>Uploaded Files</h3>
    </div>

    <script type="module">
        import { UploadClient } from './dist/index.js';

        // Initialize the upload client
        const client = new UploadClient({
            baseUrl: 'http://localhost:3000', // Change to your server URL
            timeout: 30000,
            retries: 3,
        });

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadContainer = document.getElementById('uploadContainer');
        const fileList = document.getElementById('fileList');

        let uploadedFiles = [];

        // Load previously uploaded files
        loadUploadedFiles();

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });

        function handleFiles(files) {
            files.forEach(file => {
                createUploadUI(file);
            });
        }

        function createUploadUI(file) {
            const uploadId = Date.now() + Math.random();
            const uploadDiv = document.createElement('div');
            uploadDiv.className = 'upload-item';
            uploadDiv.innerHTML = `
                <div>
                    <strong>${file.name}</strong> (${formatBytes(file.size)})
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-${uploadId}"></div>
                    </div>
                    <div class="status info" id="status-${uploadId}">Preparing upload...</div>
                </div>
                <div>
                    <button id="pause-${uploadId}" disabled>Pause</button>
                    <button id="cancel-${uploadId}">Cancel</button>
                </div>
            `;

            uploadContainer.appendChild(uploadDiv);

            const progressBar = document.getElementById(`progress-${uploadId}`);
            const statusDiv = document.getElementById(`status-${uploadId}`);
            const pauseBtn = document.getElementById(`pause-${uploadId}`);
            const cancelBtn = document.getElementById(`cancel-${uploadId}`);

            // Start upload
            client.upload({
                file,
                metadata: {
                    uploadedAt: new Date().toISOString(),
                    originalName: file.name,
                },
                onStart: (upload) => {
                    statusDiv.textContent = 'Upload started...';
                    statusDiv.className = 'status info';
                    pauseBtn.disabled = false;
                    cancelBtn.disabled = false;

                    // Attach event listeners
                    pauseBtn.onclick = async () => {
                        if (upload.state === 'uploading') {
                            await upload.pause();
                            pauseBtn.textContent = 'Resume';
                            statusDiv.textContent = 'Upload paused';
                        } else if (upload.state === 'paused') {
                            await upload.start();
                            pauseBtn.textContent = 'Pause';
                            statusDiv.textContent = 'Upload resumed';
                        }
                    };

                    cancelBtn.onclick = async () => {
                        await upload.cancel();
                        statusDiv.textContent = 'Upload cancelled';
                        statusDiv.className = 'status error';
                        pauseBtn.disabled = true;
                        cancelBtn.disabled = true;
                    };
                },
                onProgress: (progress) => {
                    progressBar.style.width = `${progress.percentage}%`;
                    statusDiv.textContent = `${progress.percentage}% uploaded (${formatBytes(progress.loaded)} / ${formatBytes(progress.total)})`;
                    if (progress.speed) {
                        statusDiv.textContent += ` - ${formatBytes(progress.speed)}/s`;
                    }
                    if (progress.eta) {
                        statusDiv.textContent += ` - ${Math.round(progress.eta)}s remaining`;
                    }
                },
                onComplete: (result) => {
                    statusDiv.textContent = `Upload complete! URL: ${result.url}`;
                    statusDiv.className = 'status success';
                    progressBar.style.width = '100%';
                    pauseBtn.disabled = true;
                    cancelBtn.disabled = true;

                    // Add to uploaded files list
                    uploadedFiles.push(result);
                    updateFileList();

                    // Remove upload UI after 3 seconds
                    setTimeout(() => {
                        uploadDiv.remove();
                    }, 3000);
                },
                onError: (error) => {
                    statusDiv.textContent = `Upload failed: ${error.message}`;
                    statusDiv.className = 'status error';
                    pauseBtn.disabled = true;
                },
            }).then(upload => {
                upload.start().catch(error => {
                    console.error('Failed to start upload:', error);
                });
            }).catch(error => {
                statusDiv.textContent = `Failed to create upload: ${error.message}`;
                statusDiv.className = 'status error';
            });
        }

        async function loadUploadedFiles() {
            try {
                // Try to get file list from server
                const response = await fetch(`${client.config.baseUrl}/files`);
                if (response.ok) {
                    const files = await response.json();
                    uploadedFiles = Array.isArray(files) ? files : [];
                    updateFileList();
                }
            } catch (error) {
                console.log('Could not load uploaded files:', error);
            }
        }

        function updateFileList() {
            const listDiv = fileList.querySelector('div') || document.createElement('div');
            listDiv.innerHTML = '';

            if (uploadedFiles.length === 0) {
                listDiv.innerHTML = '<p>No uploaded files yet</p>';
                return;
            }

            uploadedFiles.forEach(file => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-item';
                fileDiv.innerHTML = `
                    <div>
                        <strong>${file.metadata?.name || file.id}</strong>
                        <br>
                        <small>Size: ${formatBytes(file.size)} | Uploaded: ${new Date(file.metadata?.uploadedAt || Date.now()).toLocaleString()}</small>
                    </div>
                    <div>
                        <a href="${file.url}" target="_blank">View</a>
                        <button onclick="deleteFile('${file.url}', '${file.id}')">Delete</button>
                    </div>
                `;
                listDiv.appendChild(fileDiv);
            });

            fileList.appendChild(listDiv);
        }

        // Global function for deleting files
        window.deleteFile = async (url, id) => {
            if (confirm('Are you sure you want to delete this file?')) {
                try {
                    await client.delete(url);
                    uploadedFiles = uploadedFiles.filter(f => f.id !== id);
                    updateFileList();
                    alert('File deleted successfully');
                } catch (error) {
                    alert('Failed to delete file: ' + error.message);
                }
            }
        };

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
