{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage/dist/packem_shared/_commonjsHelpers-B85MJLTf.js"],"sourcesContent":["function getDefaultExportFromCjs (x) {\n\treturn x && x.__esModule && Object.prototype.hasOwnProperty.call(x, 'default') ? x['default'] : x;\n}\n\nexport { getDefaultExportFromCjs as g };\n"],"names":[],"mappings":";;;;AAAA,SAAS,wBAAyB,CAAC;IAClC,OAAO,KAAK,EAAE,UAAU,IAAI,OAAO,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,GAAG,aAAa,CAAC,CAAC,UAAU,GAAG;AACjG"}},
    {"offset": {"line": 100, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage/dist/packem_shared/part-match-CW8Z1naC.js"],"sourcesContent":["import { PassThrough, Transform } from 'node:stream';\nimport { fileTypeFromBuffer } from 'file-type';\n\nconst detectFileTypeFromBuffer = async (buffer) => {\n  try {\n    return await fileTypeFromBuffer(buffer);\n  } catch {\n    return void 0;\n  }\n};\nconst detectFileTypeFromStream = async (stream, options) => {\n  const sampleSize = 4100;\n  let fileType;\n  const chunks = [];\n  let totalLength = 0;\n  let detectionStarted = false;\n  let detectionPromise;\n  const outputStream = new PassThrough({ highWaterMark: 0 });\n  const peekStream = new Transform({\n    objectMode: false,\n    transform(chunk, _encoding, callback) {\n      if (!detectionStarted) {\n        chunks.push(chunk);\n        totalLength += chunk.length;\n        if (totalLength >= sampleSize || totalLength > 0) {\n          detectionStarted = true;\n          const buffer = Buffer.concat(chunks);\n          detectionPromise = fileTypeFromBuffer(buffer).then((detected) => {\n            fileType = detected;\n            return detected;\n          }).catch(() => void 0);\n        }\n      }\n      callback(void 0, chunk);\n    }\n  });\n  stream.pipe(peekStream).pipe(outputStream);\n  stream.on(\"error\", (error) => {\n    peekStream.destroy(error);\n    outputStream.destroy(error);\n  });\n  peekStream.on(\"error\", (error) => {\n    if (!outputStream.destroyed) {\n      outputStream.destroy(error);\n    }\n  });\n  await Promise.race([\n    new Promise((resolve) => {\n      if (detectionStarted) {\n        resolve();\n        return;\n      }\n      const timeout = setTimeout(() => resolve(), 10);\n      peekStream.once(\"data\", () => {\n        clearTimeout(timeout);\n        resolve();\n      });\n      peekStream.once(\"end\", () => {\n        clearTimeout(timeout);\n        resolve();\n      });\n    }),\n    new Promise((resolve) => {\n      setTimeout(() => resolve(), 10);\n    })\n  ]);\n  if (detectionPromise) {\n    await Promise.race([\n      detectionPromise.then(() => void 0),\n      new Promise((resolve) => {\n        setTimeout(() => resolve(), 150);\n      })\n    ]).catch(() => {\n    });\n  }\n  return { fileType, stream: outputStream };\n};\n\nconst getFileStatus = (file) => file.bytesWritten === file.size ? \"completed\" : file.createdAt ? \"part\" : \"created\";\n\nconst partMatch = (part, file) => {\n  if (part.size !== void 0 && file.size !== void 0 && part.size > 0 && file.size > 0 && part.size > file.size) {\n    return false;\n  }\n  if (file.size === void 0) {\n    return true;\n  }\n  return (part.start || 0) + (part.contentLength || 0) <= file.size;\n};\n\nexport { detectFileTypeFromBuffer as a, detectFileTypeFromStream as d, getFileStatus as g, partMatch as p };\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;;;AAEA,MAAM,2BAA2B,OAAO;IACtC,IAAI;QACF,OAAO,MAAM,IAAA,sNAAkB,EAAC;IAClC,EAAE,OAAM;QACN,OAAO,KAAK;IACd;AACF;AACA,MAAM,2BAA2B,OAAO,QAAQ;IAC9C,MAAM,aAAa;IACnB,IAAI;IACJ,MAAM,SAAS,EAAE;IACjB,IAAI,cAAc;IAClB,IAAI,mBAAmB;IACvB,IAAI;IACJ,MAAM,eAAe,IAAI,oIAAW,CAAC;QAAE,eAAe;IAAE;IACxD,MAAM,aAAa,IAAI,kIAAS,CAAC;QAC/B,YAAY;QACZ,WAAU,KAAK,EAAE,SAAS,EAAE,QAAQ;YAClC,IAAI,CAAC,kBAAkB;gBACrB,OAAO,IAAI,CAAC;gBACZ,eAAe,MAAM,MAAM;gBAC3B,IAAI,eAAe,cAAc,cAAc,GAAG;oBAChD,mBAAmB;oBACnB,MAAM,SAAS,OAAO,MAAM,CAAC;oBAC7B,mBAAmB,IAAA,sNAAkB,EAAC,QAAQ,IAAI,CAAC,CAAC;wBAClD,WAAW;wBACX,OAAO;oBACT,GAAG,KAAK,CAAC,IAAM,KAAK;gBACtB;YACF;YACA,SAAS,KAAK,GAAG;QACnB;IACF;IACA,OAAO,IAAI,CAAC,YAAY,IAAI,CAAC;IAC7B,OAAO,EAAE,CAAC,SAAS,CAAC;QAClB,WAAW,OAAO,CAAC;QACnB,aAAa,OAAO,CAAC;IACvB;IACA,WAAW,EAAE,CAAC,SAAS,CAAC;QACtB,IAAI,CAAC,aAAa,SAAS,EAAE;YAC3B,aAAa,OAAO,CAAC;QACvB;IACF;IACA,MAAM,QAAQ,IAAI,CAAC;QACjB,IAAI,QAAQ,CAAC;YACX,IAAI,kBAAkB;gBACpB;gBACA;YACF;YACA,MAAM,UAAU,WAAW,IAAM,WAAW;YAC5C,WAAW,IAAI,CAAC,QAAQ;gBACtB,aAAa;gBACb;YACF;YACA,WAAW,IAAI,CAAC,OAAO;gBACrB,aAAa;gBACb;YACF;QACF;QACA,IAAI,QAAQ,CAAC;YACX,WAAW,IAAM,WAAW;QAC9B;KACD;IACD,IAAI,kBAAkB;QACpB,MAAM,QAAQ,IAAI,CAAC;YACjB,iBAAiB,IAAI,CAAC,IAAM,KAAK;YACjC,IAAI,QAAQ,CAAC;gBACX,WAAW,IAAM,WAAW;YAC9B;SACD,EAAE,KAAK,CAAC,KACT;IACF;IACA,OAAO;QAAE;QAAU,QAAQ;IAAa;AAC1C;AAEA,MAAM,gBAAgB,CAAC,OAAS,KAAK,YAAY,KAAK,KAAK,IAAI,GAAG,cAAc,KAAK,SAAS,GAAG,SAAS;AAE1G,MAAM,YAAY,CAAC,MAAM;IACvB,IAAI,KAAK,IAAI,KAAK,KAAK,KAAK,KAAK,IAAI,KAAK,KAAK,KAAK,KAAK,IAAI,GAAG,KAAK,KAAK,IAAI,GAAG,KAAK,KAAK,IAAI,GAAG,KAAK,IAAI,EAAE;QAC3G,OAAO;IACT;IACA,IAAI,KAAK,IAAI,KAAK,KAAK,GAAG;QACxB,OAAO;IACT;IACA,OAAO,CAAC,KAAK,KAAK,IAAI,CAAC,IAAI,CAAC,KAAK,aAAa,IAAI,CAAC,KAAK,KAAK,IAAI;AACnE"}},
    {"offset": {"line": 207, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage/dist/packem_shared/ERRORS-DKaR93nv.js"],"sourcesContent":["var ERRORS = /* @__PURE__ */ ((ERRORS2) => {\n  ERRORS2[\"BAD_REQUEST\"] = \"BadRequest\";\n  ERRORS2[\"CHECKSUM_MISMATCH\"] = \"ChecksumMismatch\";\n  ERRORS2[\"FILE_CONFLICT\"] = \"FileConflict\";\n  ERRORS2[\"FILE_ERROR\"] = \"FileError\";\n  ERRORS2[\"FILE_LOCKED\"] = \"FileLocked\";\n  ERRORS2[\"FILE_NOT_ALLOWED\"] = \"FileNotAllowed\";\n  ERRORS2[\"FILE_NOT_FOUND\"] = \"FileNotFound\";\n  ERRORS2[\"FORBIDDEN\"] = \"Forbidden\";\n  ERRORS2[\"GONE\"] = \"Gone\";\n  ERRORS2[\"INVALID_FILE_NAME\"] = \"InvalidFileName\";\n  ERRORS2[\"INVALID_FILE_SIZE\"] = \"InvalidFileSize\";\n  ERRORS2[\"INVALID_RANGE\"] = \"InvalidRange\";\n  ERRORS2[\"INVALID_TYPE\"] = \"Invalidtype\";\n  ERRORS2[\"METHOD_NOT_ALLOWED\"] = \"MethodNotAllowed\";\n  ERRORS2[\"REQUEST_ABORTED\"] = \"RequestAborted\";\n  ERRORS2[\"REQUEST_ENTITY_TOO_LARGE\"] = \"RequestEntityTooLarge\";\n  ERRORS2[\"STORAGE_BUSY\"] = \"StorageBusy\";\n  ERRORS2[\"STORAGE_ERROR\"] = \"StorageError\";\n  ERRORS2[\"TOO_MANY_REQUESTS\"] = \"TooManyRequests\";\n  ERRORS2[\"UNKNOWN_ERROR\"] = \"UnknownError\";\n  ERRORS2[\"UNPROCESSABLE_ENTITY\"] = \"UnprocessableEntity\";\n  ERRORS2[\"UNSUPPORTED_CHECKSUM_ALGORITHM\"] = \"UnsupportedChecksumAlgorithm\";\n  ERRORS2[\"UNSUPPORTED_MEDIA_TYPE\"] = \"UnsupportedMediaType\";\n  return ERRORS2;\n})(ERRORS || {});\nconst ErrorMap = (() => {\n  const errors = {\n    BadRequest: [400, \"Bad request\"],\n    ChecksumMismatch: [460, \"Checksum mismatch\"],\n    FileConflict: [409, \"File conflict\"],\n    FileError: [500, \"Something went wrong writing the file\"],\n    FileLocked: [423, \"File locked\"],\n    FileNotAllowed: [403, \"File not allowed\"],\n    FileNotFound: [404, \"Not found\"],\n    Forbidden: [403, \"Authenticated user is not allowed access\"],\n    Gone: [410, \"The file for this url no longer exists\"],\n    InvalidFileName: [400, \"Invalid file name or it cannot be retrieved\"],\n    InvalidFileSize: [400, \"File size cannot be retrieved\"],\n    InvalidRange: [400, \"Invalid or missing content-range header\"],\n    Invalidtype: [400, 'Invalid or missing \"content-type\" header'],\n    MethodNotAllowed: [405, \"Method not allowed\"],\n    RequestAborted: [499, \"Request aborted\"],\n    RequestEntityTooLarge: [413, \"Request entity too large\"],\n    StorageBusy: [503, \"Storage is busy\"],\n    StorageError: [503, \"Storage error\"],\n    TooManyRequests: [429, \"Too many requests\"],\n    UnknownError: [500, \"Something went wrong\"],\n    UnprocessableEntity: [422, \"Validation failed\"],\n    UnsupportedChecksumAlgorithm: [400, \"Unsupported checksum algorithm\"],\n    UnsupportedMediaType: [415, \"Unsupported media type\"]\n  };\n  const errorMap = {};\n  Object.keys(errors).forEach((code) => {\n    const [statusCode, message] = errors[code];\n    errorMap[code] = { code, message, statusCode };\n  });\n  return errorMap;\n})();\nclass UploadError extends Error {\n  name = \"UploadError\";\n  /** The standardized error code from the ERRORS enum */\n  UploadErrorCode = \"UnknownError\" /* UNKNOWN_ERROR */;\n  /** Optional additional error details */\n  detail;\n  /**\n   * Creates a new UploadError instance.\n   * @param code Standardized error code (defaults to UNKNOWN_ERROR)\n   * @param message Human-readable error message (defaults to the code)\n   * @param detail Optional additional error details\n   */\n  constructor(code = \"UnknownError\" /* UNKNOWN_ERROR */, message, detail) {\n    super(message || code);\n    this.name = \"UploadError\";\n    this.detail = detail;\n    if (Object.values(ERRORS).includes(code)) {\n      this.UploadErrorCode = code;\n    }\n  }\n}\nconst isUploadError = (error) => !!error.UploadErrorCode;\nconst throwErrorCode = (UploadErrorCode, detail) => {\n  const errorResponse = ErrorMap[UploadErrorCode];\n  const error = new UploadError(detail || errorResponse?.message || \"UnknownError\" /* UNKNOWN_ERROR */);\n  error.UploadErrorCode = UploadErrorCode;\n  if (typeof detail === \"string\") {\n    error.detail = detail;\n  }\n  throw error;\n};\n\nexport { ERRORS, ErrorMap, UploadError, isUploadError, throwErrorCode };\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA,IAAI,SAAS,aAAa,GAAG,CAAC,CAAC;IAC7B,OAAO,CAAC,cAAc,GAAG;IACzB,OAAO,CAAC,oBAAoB,GAAG;IAC/B,OAAO,CAAC,gBAAgB,GAAG;IAC3B,OAAO,CAAC,aAAa,GAAG;IACxB,OAAO,CAAC,cAAc,GAAG;IACzB,OAAO,CAAC,mBAAmB,GAAG;IAC9B,OAAO,CAAC,iBAAiB,GAAG;IAC5B,OAAO,CAAC,YAAY,GAAG;IACvB,OAAO,CAAC,OAAO,GAAG;IAClB,OAAO,CAAC,oBAAoB,GAAG;IAC/B,OAAO,CAAC,oBAAoB,GAAG;IAC/B,OAAO,CAAC,gBAAgB,GAAG;IAC3B,OAAO,CAAC,eAAe,GAAG;IAC1B,OAAO,CAAC,qBAAqB,GAAG;IAChC,OAAO,CAAC,kBAAkB,GAAG;IAC7B,OAAO,CAAC,2BAA2B,GAAG;IACtC,OAAO,CAAC,eAAe,GAAG;IAC1B,OAAO,CAAC,gBAAgB,GAAG;IAC3B,OAAO,CAAC,oBAAoB,GAAG;IAC/B,OAAO,CAAC,gBAAgB,GAAG;IAC3B,OAAO,CAAC,uBAAuB,GAAG;IAClC,OAAO,CAAC,iCAAiC,GAAG;IAC5C,OAAO,CAAC,yBAAyB,GAAG;IACpC,OAAO;AACT,CAAC,EAAE,UAAU,CAAC;AACd,MAAM,WAAW,CAAC;IAChB,MAAM,SAAS;QACb,YAAY;YAAC;YAAK;SAAc;QAChC,kBAAkB;YAAC;YAAK;SAAoB;QAC5C,cAAc;YAAC;YAAK;SAAgB;QACpC,WAAW;YAAC;YAAK;SAAwC;QACzD,YAAY;YAAC;YAAK;SAAc;QAChC,gBAAgB;YAAC;YAAK;SAAmB;QACzC,cAAc;YAAC;YAAK;SAAY;QAChC,WAAW;YAAC;YAAK;SAA2C;QAC5D,MAAM;YAAC;YAAK;SAAyC;QACrD,iBAAiB;YAAC;YAAK;SAA8C;QACrE,iBAAiB;YAAC;YAAK;SAAgC;QACvD,cAAc;YAAC;YAAK;SAA0C;QAC9D,aAAa;YAAC;YAAK;SAA2C;QAC9D,kBAAkB;YAAC;YAAK;SAAqB;QAC7C,gBAAgB;YAAC;YAAK;SAAkB;QACxC,uBAAuB;YAAC;YAAK;SAA2B;QACxD,aAAa;YAAC;YAAK;SAAkB;QACrC,cAAc;YAAC;YAAK;SAAgB;QACpC,iBAAiB;YAAC;YAAK;SAAoB;QAC3C,cAAc;YAAC;YAAK;SAAuB;QAC3C,qBAAqB;YAAC;YAAK;SAAoB;QAC/C,8BAA8B;YAAC;YAAK;SAAiC;QACrE,sBAAsB;YAAC;YAAK;SAAyB;IACvD;IACA,MAAM,WAAW,CAAC;IAClB,OAAO,IAAI,CAAC,QAAQ,OAAO,CAAC,CAAC;QAC3B,MAAM,CAAC,YAAY,QAAQ,GAAG,MAAM,CAAC,KAAK;QAC1C,QAAQ,CAAC,KAAK,GAAG;YAAE;YAAM;YAAS;QAAW;IAC/C;IACA,OAAO;AACT,CAAC;AACD,MAAM,oBAAoB;IACxB,OAAO,cAAc;IACrB,qDAAqD,GACrD,kBAAkB,eAAe,iBAAiB,IAAG;IACrD,sCAAsC,GACtC,OAAO;IACP;;;;;GAKC,GACD,YAAY,OAAO,eAAe,iBAAiB,GAAlB,EAAsB,OAAO,EAAE,MAAM,CAAE;QACtE,KAAK,CAAC,WAAW;QACjB,IAAI,CAAC,IAAI,GAAG;QACZ,IAAI,CAAC,MAAM,GAAG;QACd,IAAI,OAAO,MAAM,CAAC,QAAQ,QAAQ,CAAC,OAAO;YACxC,IAAI,CAAC,eAAe,GAAG;QACzB;IACF;AACF;AACA,MAAM,gBAAgB,CAAC,QAAU,CAAC,CAAC,MAAM,eAAe;AACxD,MAAM,iBAAiB,CAAC,iBAAiB;IACvC,MAAM,gBAAgB,QAAQ,CAAC,gBAAgB;IAC/C,MAAM,QAAQ,IAAI,YAAY,UAAU,eAAe,WAAW,eAAe,iBAAiB;IAClG,MAAM,eAAe,GAAG;IACxB,IAAI,OAAO,WAAW,UAAU;QAC9B,MAAM,MAAM,GAAG;IACjB;IACA,MAAM;AACR"}},
    {"offset": {"line": 408, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage/dist/packem_shared/NoOpMetrics-DhAk5rXc.js"],"sourcesContent":["class NoOpMetrics {\n  increment(_name, _value, _attributes) {\n  }\n  timing(_name, _duration, _attributes) {\n  }\n  gauge(_name, _value, _attributes) {\n  }\n}\n\nexport { NoOpMetrics as default };\n"],"names":[],"mappings":";;;;AAAA,MAAM;IACJ,UAAU,KAAK,EAAE,MAAM,EAAE,WAAW,EAAE,CACtC;IACA,OAAO,KAAK,EAAE,SAAS,EAAE,WAAW,EAAE,CACtC;IACA,MAAM,KAAK,EAAE,MAAM,EAAE,WAAW,EAAE,CAClC;AACF"}},
    {"offset": {"line": 422, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage/dist/packem_shared/cache-B88MXQ_2.js"],"sourcesContent":["class NoOpCache {\n  get() {\n    return void 0;\n  }\n  set() {\n    return true;\n  }\n  delete() {\n    return true;\n  }\n  clear() {\n  }\n  has() {\n    return false;\n  }\n}\n\nexport { NoOpCache as N };\n"],"names":[],"mappings":";;;;AAAA,MAAM;IACJ,MAAM;QACJ,OAAO,KAAK;IACd;IACA,MAAM;QACJ,OAAO;IACT;IACA,SAAS;QACP,OAAO;IACT;IACA,QAAQ,CACR;IACA,MAAM;QACJ,OAAO;IACT;AACF"}},
    {"offset": {"line": 446, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage/dist/packem_shared/validator-InvzeyVl.js"],"sourcesContent":["import { ErrorMap } from './ERRORS-DKaR93nv.js';\n\nclass ValidationError extends Error {\n  /**\n   * Creates a new ValidationError instance.\n   * @param code Machine-readable error code\n   * @param statusCode HTTP status code for the error\n   * @param body Error response body (string or structured object)\n   * @param headers HTTP headers to include in error response\n   */\n  constructor(code, statusCode, body, headers) {\n    super(typeof body === \"string\" ? body : body?.message);\n    this.code = code;\n    this.statusCode = statusCode;\n    this.body = body;\n    this.headers = headers;\n    this.name = \"ValidationError\";\n  }\n}\n\nconst capitalize = (s) => s && s[0].toUpperCase() + s.slice(1);\nconst toResponse = (response) => {\n  if (!Array.isArray(response)) {\n    return response;\n  }\n  const [statusCode, body, headers] = response;\n  return { body, headers, statusCode };\n};\nclass Validator {\n  /**\n   * Creates a new Validator instance.\n   * @param prefix Prefix for generated error codes (default: \"ValidationError\")\n   */\n  constructor(prefix = \"ValidationError\") {\n    this.prefix = prefix;\n  }\n  validators = {};\n  /**\n   * Adds validation rules to the validator.\n   * Each rule must include an `isValid` function.\n   * @param config Validation configuration object\n   * @throws TypeError if any validator is missing the isValid function\n   */\n  add(config) {\n    Object.entries(config).forEach(([key, validator]) => {\n      const code = `${this.prefix}${capitalize(key)}`;\n      this.validators[code] = { ...this.validators[code], ...validator };\n      if (typeof this.validators[code].isValid !== \"function\") {\n        throw new TypeError('Validation config \"isValid\" is missing, or it is not a function!');\n      }\n    });\n  }\n  /**\n   * Verifies an object against all configured validation rules.\n   * Throws ValidationError on first validation failure.\n   * @param t Object to validate\n   * @throws ValidationError if validation fails\n   */\n  async verify(t) {\n    for await (const [code, validator] of Object.entries(this.validators)) {\n      const isValid = await validator.isValid(t);\n      if (!isValid) {\n        const errorResponse = validator.response || (code in ErrorMap ? ErrorMap[code] : ErrorMap.UnknownError);\n        const response = toResponse(errorResponse);\n        const { body, headers, message, statusCode } = response;\n        throw new ValidationError(code, statusCode, body || message, headers);\n      }\n    }\n  }\n}\nconst isValidationError = (error) => error.name === \"ValidationError\";\n\nexport { ValidationError as V, Validator as a, isValidationError as i };\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,MAAM,wBAAwB;IAC5B;;;;;;GAMC,GACD,YAAY,IAAI,EAAE,UAAU,EAAE,IAAI,EAAE,OAAO,CAAE;QAC3C,KAAK,CAAC,OAAO,SAAS,WAAW,OAAO,MAAM;QAC9C,IAAI,CAAC,IAAI,GAAG;QACZ,IAAI,CAAC,UAAU,GAAG;QAClB,IAAI,CAAC,IAAI,GAAG;QACZ,IAAI,CAAC,OAAO,GAAG;QACf,IAAI,CAAC,IAAI,GAAG;IACd;AACF;AAEA,MAAM,aAAa,CAAC,IAAM,KAAK,CAAC,CAAC,EAAE,CAAC,WAAW,KAAK,EAAE,KAAK,CAAC;AAC5D,MAAM,aAAa,CAAC;IAClB,IAAI,CAAC,MAAM,OAAO,CAAC,WAAW;QAC5B,OAAO;IACT;IACA,MAAM,CAAC,YAAY,MAAM,QAAQ,GAAG;IACpC,OAAO;QAAE;QAAM;QAAS;IAAW;AACrC;AACA,MAAM;IACJ;;;GAGC,GACD,YAAY,SAAS,iBAAiB,CAAE;QACtC,IAAI,CAAC,MAAM,GAAG;IAChB;IACA,aAAa,CAAC,EAAE;IAChB;;;;;GAKC,GACD,IAAI,MAAM,EAAE;QACV,OAAO,OAAO,CAAC,QAAQ,OAAO,CAAC,CAAC,CAAC,KAAK,UAAU;YAC9C,MAAM,OAAO,GAAG,IAAI,CAAC,MAAM,GAAG,WAAW,MAAM;YAC/C,IAAI,CAAC,UAAU,CAAC,KAAK,GAAG;gBAAE,GAAG,IAAI,CAAC,UAAU,CAAC,KAAK;gBAAE,GAAG,SAAS;YAAC;YACjE,IAAI,OAAO,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,OAAO,KAAK,YAAY;gBACvD,MAAM,IAAI,UAAU;YACtB;QACF;IACF;IACA;;;;;GAKC,GACD,MAAM,OAAO,CAAC,EAAE;QACd,WAAW,MAAM,CAAC,MAAM,UAAU,IAAI,OAAO,OAAO,CAAC,IAAI,CAAC,UAAU,EAAG;YACrE,MAAM,UAAU,MAAM,UAAU,OAAO,CAAC;YACxC,IAAI,CAAC,SAAS;gBACZ,MAAM,gBAAgB,UAAU,QAAQ,IAAI,CAAC,QAAQ,gLAAQ,GAAG,gLAAQ,CAAC,KAAK,GAAG,gLAAQ,CAAC,YAAY;gBACtG,MAAM,WAAW,WAAW;gBAC5B,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,OAAO,EAAE,UAAU,EAAE,GAAG;gBAC/C,MAAM,IAAI,gBAAgB,MAAM,YAAY,QAAQ,SAAS;YAC/D;QACF;IACF;AACF;AACA,MAAM,oBAAoB,CAAC,QAAU,MAAM,IAAI,KAAK"}},
    {"offset": {"line": 532, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage/dist/packem_shared/path-CR6YkPXX-7R1-9CMk.js"],"sourcesContent":["const DRIVE_LETTER_START_RE = /^[A-Z]:\\//i;\nconst normalizeWindowsPath = (input = \"\") => {\n  if (!input) {\n    return input;\n  }\n  return input.replaceAll(\"\\\\\", \"/\").replace(DRIVE_LETTER_START_RE, (r) => r.toUpperCase());\n};\nconst UNC_REGEX = /^[/\\\\]{2}/;\nconst IS_ABSOLUTE_RE = /^[/\\\\](?![/\\\\])|^[/\\\\]{2}(?!\\.)|^[A-Z]:[/\\\\]/i;\nconst DRIVE_LETTER_RE = /^[A-Z]:$/i;\nconst cwd = () => {\n  if (typeof process.cwd === \"function\") {\n    return process.cwd().replaceAll(\"\\\\\", \"/\");\n  }\n  return \"/\";\n};\nconst normalizeString = (path2, allowAboveRoot) => {\n  let result = \"\";\n  let lastSegmentLength = 0;\n  let lastSlash = -1;\n  let dots = 0;\n  let char;\n  for (let index = 0; index <= path2.length; ++index) {\n    if (index < path2.length) {\n      char = path2[index];\n    } else if (char === \"/\") {\n      break;\n    } else {\n      char = \"/\";\n    }\n    if (char === \"/\") {\n      if (lastSlash === index - 1 || dots === 1) ;\n      else if (dots === 2) {\n        if (result.length < 2 || lastSegmentLength !== 2 || !result.endsWith(\".\") || result.at(-2) !== \".\") {\n          if (result.length > 2) {\n            const lastSlashIndex = result.lastIndexOf(\"/\");\n            if (lastSlashIndex === -1) {\n              result = \"\";\n              lastSegmentLength = 0;\n            } else {\n              result = result.slice(0, lastSlashIndex);\n              lastSegmentLength = result.length - 1 - result.lastIndexOf(\"/\");\n            }\n            lastSlash = index;\n            dots = 0;\n            continue;\n          } else if (result.length > 0) {\n            result = \"\";\n            lastSegmentLength = 0;\n            lastSlash = index;\n            dots = 0;\n            continue;\n          }\n        }\n        if (allowAboveRoot) {\n          result += result.length > 0 ? \"/..\" : \"..\";\n          lastSegmentLength = 2;\n        }\n      } else {\n        if (result.length > 0) {\n          result += `/${path2.slice(lastSlash + 1, index)}`;\n        } else {\n          result = path2.slice(lastSlash + 1, index);\n        }\n        lastSegmentLength = index - lastSlash - 1;\n      }\n      lastSlash = index;\n      dots = 0;\n    } else if (char === \".\" && dots !== -1) {\n      ++dots;\n    } else {\n      dots = -1;\n    }\n  }\n  return result;\n};\nconst isAbsolute = (path2) => IS_ABSOLUTE_RE.test(path2);\nconst normalize = function(path2) {\n  if (path2.length === 0) {\n    return \".\";\n  }\n  path2 = normalizeWindowsPath(path2);\n  const isUNCPath = UNC_REGEX.exec(path2);\n  const isPathAbsolute = isAbsolute(path2);\n  const trailingSeparator = path2.at(-1) === \"/\";\n  path2 = normalizeString(path2, !isPathAbsolute);\n  if (path2.length === 0) {\n    if (isPathAbsolute) {\n      return \"/\";\n    }\n    return trailingSeparator ? \"./\" : \".\";\n  }\n  if (trailingSeparator) {\n    path2 += \"/\";\n  }\n  if (DRIVE_LETTER_RE.test(path2)) {\n    path2 += \"/\";\n  }\n  if (isUNCPath) {\n    if (!isPathAbsolute) {\n      return `//./${path2}`;\n    }\n    return `//${path2}`;\n  }\n  return isPathAbsolute && !isAbsolute(path2) ? `/${path2}` : path2;\n};\nconst join = (...segments) => {\n  let path2 = \"\";\n  for (const seg of segments) {\n    if (!seg) {\n      continue;\n    }\n    if (path2.length > 0) {\n      const pathTrailing = path2[path2.length - 1] === \"/\";\n      const segLeading = seg[0] === \"/\";\n      const both = pathTrailing && segLeading;\n      if (both) {\n        path2 += seg.slice(1);\n      } else {\n        path2 += pathTrailing || segLeading ? seg : `/${seg}`;\n      }\n    } else {\n      path2 += seg;\n    }\n  }\n  return normalize(path2);\n};\nconst resolve = function(...arguments_) {\n  arguments_ = arguments_.map((argument) => normalizeWindowsPath(argument));\n  let resolvedPath = \"\";\n  let resolvedAbsolute = false;\n  for (let index = arguments_.length - 1; index >= -1 && !resolvedAbsolute; index--) {\n    const path2 = index >= 0 ? arguments_[index] : cwd();\n    if (!path2 || path2.length === 0) {\n      continue;\n    }\n    resolvedPath = `${path2}/${resolvedPath}`;\n    resolvedAbsolute = isAbsolute(path2);\n  }\n  resolvedPath = normalizeString(resolvedPath, !resolvedAbsolute);\n  if (resolvedAbsolute && !isAbsolute(resolvedPath)) {\n    return `/${resolvedPath}`;\n  }\n  return resolvedPath.length > 0 ? resolvedPath : \".\";\n};\nconst dirname = (path2) => {\n  const segments = normalizeWindowsPath(path2).replace(/\\/$/, \"\").split(\"/\").slice(0, -1);\n  if (segments.length === 1 && DRIVE_LETTER_RE.test(segments[0])) {\n    segments[0] += \"/\";\n  }\n  return segments.join(\"/\") || (isAbsolute(path2) ? \"/\" : \".\");\n};\nconst basename = (path2, extension) => {\n  const lastSegment = normalizeWindowsPath(path2).split(\"/\").pop();\n  if (extension && lastSegment.endsWith(extension)) {\n    return lastSegment.slice(0, -extension.length);\n  }\n  return lastSegment;\n};\n\nexport { normalizeWindowsPath as a, basename as b, dirname as d, isAbsolute as i, join as j, normalize as n, resolve as r };\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 712, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage/dist/packem_shared/is-expired-CTThU1q5.js"],"sourcesContent":["const isExpired = (file) => {\n  if (!file.expiredAt) {\n    return false;\n  }\n  return Date.now() > +new Date(file.expiredAt);\n};\n\nexport { isExpired as i };\n"],"names":[],"mappings":";;;;AAAA,MAAM,YAAY,CAAC;IACjB,IAAI,CAAC,KAAK,SAAS,EAAE;QACnB,OAAO;IACT;IACA,OAAO,KAAK,GAAG,KAAK,CAAC,IAAI,KAAK,KAAK,SAAS;AAC9C"}},
    {"offset": {"line": 727, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage/dist/packem_shared/storage-qBIeShej.js"],"sourcesContent":["import { Readable } from 'node:stream';\nimport { setInterval } from 'node:timers';\nimport { inspect } from 'node:util';\nimport typeis from 'type-is';\nimport NoOpMetrics from './NoOpMetrics-DhAk5rXc.js';\nimport { N as NoOpCache } from './cache-B88MXQ_2.js';\nimport { ErrorMap, throwErrorCode, ERRORS } from './ERRORS-DKaR93nv.js';\nimport { LRUCache } from 'lru-cache';\nimport { a as Validator } from './validator-InvzeyVl.js';\nimport { n as normalize, i as isAbsolute } from './path-CR6YkPXX-7R1-9CMk.js';\nimport { i as isExpired } from './is-expired-CTThU1q5.js';\n\nconst BYTE_SIZES = {\n  iec: [\n    {\n      long: \"Bytes\",\n      short: \"B\"\n    },\n    {\n      long: \"Kibibytes\",\n      short: \"KiB\"\n    },\n    {\n      long: \"Mebibytes\",\n      short: \"MiB\"\n    },\n    {\n      long: \"Gibibytes\",\n      short: \"GiB\"\n    },\n    {\n      long: \"Tebibytes\",\n      short: \"TiB\"\n    },\n    {\n      long: \"Pebibytes\",\n      short: \"PiB\"\n    },\n    {\n      long: \"Exbibytes\",\n      short: \"EiB\"\n    },\n    {\n      long: \"Zebibytes\",\n      short: \"ZiB\"\n    },\n    {\n      long: \"Yobibytes\",\n      short: \"YiB\"\n    }\n  ],\n  iec_octet: [\n    {\n      long: \"Octets\",\n      short: \"o\"\n    },\n    {\n      long: \"Kibioctets\",\n      short: \"Kio\"\n    },\n    {\n      long: \"Mebioctets\",\n      short: \"Mio\"\n    },\n    {\n      long: \"Gibioctets\",\n      short: \"Gio\"\n    },\n    {\n      long: \"Tebioctets\",\n      short: \"Tio\"\n    },\n    {\n      long: \"Pebioctets\",\n      short: \"Pio\"\n    },\n    {\n      long: \"Exbioctets\",\n      short: \"Eio\"\n    },\n    {\n      long: \"Zebioctets\",\n      short: \"Zio\"\n    },\n    {\n      long: \"Yobioctets\",\n      short: \"Yio\"\n    }\n  ],\n  metric: [\n    {\n      long: \"Bytes\",\n      short: \"Bytes\"\n    },\n    {\n      long: \"Kilobytes\",\n      short: \"KB\"\n    },\n    {\n      long: \"Megabytes\",\n      short: \"MB\"\n    },\n    {\n      long: \"Gigabytes\",\n      short: \"GB\"\n    },\n    {\n      long: \"Terabytes\",\n      short: \"TB\"\n    },\n    {\n      long: \"Petabytes\",\n      short: \"PB\"\n    },\n    {\n      long: \"Exabytes\",\n      short: \"EB\"\n    },\n    {\n      long: \"Zettabytes\",\n      short: \"ZB\"\n    },\n    {\n      long: \"Yottabytes\",\n      short: \"YB\"\n    }\n  ],\n  metric_octet: [\n    {\n      long: \"Octets\",\n      short: \"o\"\n    },\n    {\n      long: \"Kilo-octets\",\n      short: \"ko\"\n    },\n    {\n      long: \"Mega-octets\",\n      short: \"Mo\"\n    },\n    {\n      long: \"Giga-octets\",\n      short: \"Go\"\n    },\n    {\n      long: \"Tera-octets\",\n      short: \"To\"\n    },\n    {\n      long: \"Peta-octets\",\n      short: \"Po\"\n    },\n    {\n      long: \"Exa-octets\",\n      short: \"Eo\"\n    },\n    {\n      long: \"Zetta-octets\",\n      short: \"Zo\"\n    },\n    {\n      long: \"Yotta-octets\",\n      short: \"Yo\"\n    }\n  ]\n};\nconst parseLocalizedNumber = (stringNumber, locale) => {\n  const thousandSeparator = new Intl.NumberFormat(locale).format(11111).replaceAll(new RegExp(\"\\\\p{Number}\", \"gu\"), \"\");\n  const decimalSeparator = new Intl.NumberFormat(locale).format(1.1).replaceAll(new RegExp(\"\\\\p{Number}\", \"gu\"), \"\");\n  return Number.parseFloat(stringNumber.replaceAll(new RegExp(`\\\\${thousandSeparator}`, \"g\"), \"\").replace(new RegExp(`\\\\${decimalSeparator}`), \".\"));\n};\nconst fromBase = (base) => {\n  if (base === 2) {\n    return 1024;\n  }\n  if (base === 10) {\n    return 1e3;\n  }\n  throw new TypeError(`Unsupported base.`);\n};\nconst parseBytes = (value, options) => {\n  const config = {\n    base: 2,\n    locale: \"en-US\",\n    units: \"metric\",\n    ...options\n  };\n  if (typeof value !== \"string\" || value.length === 0) {\n    throw new TypeError(\"Value is not a string or is empty.\");\n  }\n  if (value.length > 100) {\n    throw new TypeError(\"Value exceeds the maximum length of 100 characters.\");\n  }\n  const match = /^(?<value>-?(?:\\d+(([.,])\\d+)*)?[.,]?\\d+) *(?<type>bytes?|b|kb|kib|mb|mib|gb|gib|tb|tib|pb|pib|eb|eib|zb|zib|yb|yib|(kilo|kibi|mega|mebi|giga|gibi|tera|tebi|peta|pebi|exa|exbi|zetta|zebi|yotta|yobi)?bytes)?$/i.exec(\n    value\n  );\n  const groups = match?.groups;\n  if (!groups) {\n    return Number.NaN;\n  }\n  const localizedNumber = parseLocalizedNumber(groups.value, config.locale);\n  const type = (groups.type ?? \"Bytes\").toUpperCase().replace(/^KIBI/, \"KILO\").replace(/^MIBI/, \"MEGA\").replace(/^GIBI/, \"GIGA\").replace(/^TEBI/, \"TERA\").replace(/^PEBI/, \"PETA\").replace(/^EXBI/, \"EXA\").replace(/^ZEBI/, \"ZETTA\").replace(/^YIBI/, \"YOTTA\").replace(/^(.)IB$/, \"$1B\");\n  const level = BYTE_SIZES[config.units].findIndex((unit) => unit.short[0].toUpperCase() === type[0]);\n  const base = fromBase(config.base);\n  return localizedNumber * base ** level;\n};\n\nconst createDurationLanguage = (y, mo, w, d, h, m, s, ms, future, past, decimal, unitMap, groupSeparator, placeholderSeparator) => {\n  const result = {\n    d,\n    h,\n    m,\n    mo,\n    ms,\n    s,\n    w,\n    y\n  };\n  {\n    result.future = future;\n  }\n  {\n    result.past = past;\n  }\n  {\n    result.decimal = decimal;\n  }\n  if (unitMap !== void 0) {\n    result.unitMap = unitMap;\n  }\n  {\n    result.groupSeparator = groupSeparator;\n  }\n  {\n    result.placeholderSeparator = placeholderSeparator;\n  }\n  return result;\n};\n\nconst englishUnitMap = {\n  d: \"d\",\n  day: \"d\",\n  days: \"d\",\n  h: \"h\",\n  hour: \"h\",\n  hours: \"h\",\n  hr: \"h\",\n  hrs: \"h\",\n  m: \"m\",\n  millisecond: \"ms\",\n  milliseconds: \"ms\",\n  min: \"m\",\n  mins: \"m\",\n  minute: \"m\",\n  minutes: \"m\",\n  mo: \"mo\",\n  month: \"mo\",\n  months: \"mo\",\n  ms: \"ms\",\n  s: \"s\",\n  sec: \"s\",\n  second: \"s\",\n  seconds: \"s\",\n  secs: \"s\",\n  w: \"w\",\n  week: \"w\",\n  weeks: \"w\",\n  y: \"y\",\n  year: \"y\",\n  years: \"y\",\n  yr: \"y\",\n  yrs: \"y\"\n};\nconst durationLanguage = createDurationLanguage(\n  (counter) => `year${counter === 1 ? \"\" : \"s\"}`,\n  (counter) => `month${counter === 1 ? \"\" : \"s\"}`,\n  (counter) => `week${counter === 1 ? \"\" : \"s\"}`,\n  (counter) => `day${counter === 1 ? \"\" : \"s\"}`,\n  (counter) => `hour${counter === 1 ? \"\" : \"s\"}`,\n  (counter) => `minute${counter === 1 ? \"\" : \"s\"}`,\n  (counter) => `second${counter === 1 ? \"\" : \"s\"}`,\n  (counter) => `millisecond${counter === 1 ? \"\" : \"s\"}`,\n  \"in %s\",\n  \"%s ago\",\n  \".\",\n  // decimal\n  englishUnitMap,\n  \",\",\n  // groupSeparator\n  \"_\"\n  // placeholderSeparator\n);\n\nconst validateDurationLanguage = (language) => {\n  const requiredProperties = [\"y\", \"mo\", \"w\", \"d\", \"h\", \"m\", \"s\", \"ms\", \"future\", \"past\"];\n  for (const property of requiredProperties) {\n    if (!Object.prototype.hasOwnProperty.call(language, property)) {\n      throw new TypeError(`Missing required property: ${property}`);\n    }\n  }\n  if (typeof language.future !== \"string\" || typeof language.past !== \"string\") {\n    throw new TypeError(\"Properties future and past must be of type string\");\n  }\n  for (const property of [\"y\", \"mo\", \"w\", \"d\", \"h\", \"m\", \"s\", \"ms\"]) {\n    if (typeof language[property] !== \"string\" && typeof language[property] !== \"function\") {\n      throw new TypeError(`Property ${property} must be of type string or function`);\n    }\n  }\n  if (language.decimal && typeof language.decimal !== \"string\") {\n    throw new TypeError(\"Property decimal must be of type string\");\n  }\n  if (language.delimiter && typeof language.delimiter !== \"string\") {\n    throw new TypeError(\"Property delimiter must be of type string\");\n  }\n  if (language._digitReplacements && !Array.isArray(language._digitReplacements)) {\n    throw new TypeError(\"Property _digitReplacements must be an array\");\n  }\n  if (language._numberFirst && typeof language._numberFirst !== \"boolean\") {\n    throw new TypeError(\"Property _numberFirst must be of type boolean\");\n  }\n  if (language.unitMap && typeof language.unitMap !== \"object\") {\n    throw new TypeError(\"Property unitMap must be an object\");\n  }\n  if (language.unitMap && Object.values(language.unitMap).some((value) => typeof value !== \"string\")) {\n    throw new TypeError(\"All values in unitMap must be of type string\");\n  }\n};\n\nconst STANDARD_UNIT_MEASURES = {\n  d: 864e5,\n  h: 36e5,\n  m: 6e4,\n  mo: 2629746e3,\n  ms: 1,\n  s: 1e3,\n  w: 6048e5,\n  y: 31556952e3\n};\nconst ESCAPE_REGEX = /[-/\\\\^$*+?.()|[\\]{}]/g;\nconst ISO_FORMAT = /^PT(?:(\\d+)H)?(?:(\\d+)M)?(?:(\\d+)S)?$/i;\nconst COLON_FORMAT = /^(?:(\\d+):)?(?:(\\d+):)?(\\d+)$/;\nconst NUMERIC_STRING_REGEX = /^[+-]?\\d+(?:\\.\\d+)?$/;\nconst parseDuration = (value, options) => {\n  if (typeof value !== \"string\" || value.length === 0) {\n    return void 0;\n  }\n  const { defaultUnit = \"ms\", language = durationLanguage } = {};\n  validateDurationLanguage(language);\n  const decimalSeparator = language.decimal ?? \".\";\n  const groupSeparator = language.groupSeparator ?? \",\";\n  const placeholderSeparator = language.placeholderSeparator ?? \"_\";\n  const escapedDecimal = decimalSeparator.replaceAll(ESCAPE_REGEX, String.raw`\\$&`);\n  const escapedGroup = groupSeparator.replaceAll(ESCAPE_REGEX, String.raw`\\$&`);\n  const escapedPlaceholder = placeholderSeparator.replaceAll(ESCAPE_REGEX, String.raw`\\$&`);\n  const currentUnitMap = language.unitMap ?? englishUnitMap;\n  let processedValue = value.replaceAll(new RegExp(`(\\\\d)[${escapedPlaceholder}${escapedGroup}](\\\\d)`, \"g\"), \"$1$2\");\n  if (decimalSeparator !== \".\") {\n    processedValue = processedValue.replace(escapedDecimal, \".\");\n  }\n  if (NUMERIC_STRING_REGEX.test(value)) {\n    const numberOnly = Number.parseFloat(processedValue.trim());\n    if (!Number.isNaN(numberOnly)) {\n      const unitKey = currentUnitMap[defaultUnit];\n      if (unitKey !== void 0) {\n        return numberOnly * STANDARD_UNIT_MEASURES[unitKey];\n      }\n    }\n    return void 0;\n  }\n  const isoMatch = ISO_FORMAT.exec(value);\n  if (isoMatch) {\n    const hours = Number.parseInt(isoMatch[1] ?? \"0\", 10);\n    const minutes = Number.parseInt(isoMatch[2] ?? \"0\", 10);\n    const seconds = Number.parseInt(isoMatch[3] ?? \"0\", 10);\n    return hours * 36e5 + minutes * 6e4 + seconds * 1e3;\n  }\n  const colonMatch = COLON_FORMAT.exec(value);\n  if (colonMatch) {\n    let hours = 0;\n    let minutes = 0;\n    let seconds = 0;\n    if (colonMatch[2] !== void 0) {\n      hours = Number.parseInt(colonMatch[1] ?? \"0\", 10);\n      minutes = Number.parseInt(colonMatch[2], 10);\n    } else if (colonMatch[1] !== void 0) {\n      minutes = Number.parseInt(colonMatch[1], 10);\n    }\n    seconds = Number.parseInt(colonMatch[3] ?? \"0\", 10);\n    return hours * 36e5 + minutes * 6e4 + seconds * 1e3;\n  }\n  const currentUnitMapKeys = Object.keys(currentUnitMap);\n  const regexKeys = currentUnitMapKeys.toSorted((a, b) => b.length - a.length).map((k) => k.replaceAll(ESCAPE_REGEX, String.raw`\\$&`)).join(\"|\");\n  const durationRegex = new RegExp(`(-?\\\\d*\\\\.?\\\\d+)\\\\s*(${regexKeys})`, \"gi\");\n  let totalMs = 0;\n  let match;\n  let unitsFound = false;\n  let firstMatchIndex = -1;\n  let lastMatchEndIndex = 0;\n  durationRegex.lastIndex = 0;\n  while ((match = durationRegex.exec(processedValue)) !== null) {\n    if (!unitsFound) {\n      firstMatchIndex = match.index;\n    }\n    unitsFound = true;\n    const numberString = match[1];\n    const unitString = match[2];\n    if (!numberString || !unitString) {\n      continue;\n    }\n    const trimmedNumberString = numberString.trim();\n    const sign = trimmedNumberString.startsWith(\"-\") ? -1 : 1;\n    const absNumberString = trimmedNumberString.replace(/^[-+]/, \"\");\n    const parsedNumber = Number.parseFloat(absNumberString);\n    const unitKey = currentUnitMap[unitString.toLowerCase()];\n    if (unitKey === void 0) {\n      continue;\n    }\n    const unitValue = STANDARD_UNIT_MEASURES[unitKey];\n    if (Number.isNaN(parsedNumber)) {\n      return void 0;\n    }\n    totalMs += sign * parsedNumber * unitValue;\n    lastMatchEndIndex = durationRegex.lastIndex;\n  }\n  const leadingText = processedValue.slice(0, firstMatchIndex).trim();\n  const trailingText = processedValue.slice(lastMatchEndIndex).trim();\n  if (unitsFound && (leadingText.length > 0 || trailingText.length > 0)) {\n    return void 0;\n  }\n  if (!unitsFound) {\n    return void 0;\n  }\n  return totalMs;\n};\n\nconst toMilliseconds = (value) => {\n  if (value === Number(value)) {\n    return value;\n  }\n  if (!value) {\n    return void 0;\n  }\n  const parsed = parseDuration(value);\n  if (parsed === void 0) {\n    return void 0;\n  }\n  return parsed;\n};\n\nclass Locker extends LRUCache {\n  /**\n   * Creates a new Locker instance with configurable TTL and cache options.\n   * @param options LRU cache configuration options\n   */\n  constructor(options) {\n    super({\n      ttl: 1e3,\n      ttlAutopurge: true,\n      ...options\n    });\n  }\n  /**\n   * Acquires a lock for the specified key.\n   * Throws an error if the key is already locked.\n   * @param key The key to lock\n   * @returns The lock token (same as the key)\n   * @throws Error if the key is already locked\n   */\n  lock(key) {\n    const locked = this.get(key);\n    if (locked) {\n      throw new Error(`${key} is locked`);\n    }\n    this.set(key, key);\n    return key;\n  }\n  /**\n   * Releases the lock for the specified key.\n   * @param key The key to unlock\n   */\n  unlock(key) {\n    this.delete(key);\n  }\n}\n\nconst extractOriginalName = (meta) => {\n  if (typeof meta.name === \"string\") {\n    return meta.name;\n  }\n  if (typeof meta.title === \"string\") {\n    return meta.title;\n  }\n  if (typeof meta.originalName === \"string\") {\n    return meta.originalName;\n  }\n  if (typeof meta.filename === \"string\") {\n    return meta.filename;\n  }\n  return void 0;\n};\nconst deepMerge = (target, source) => {\n  const result = { ...target };\n  Object.keys(source).forEach((key) => {\n    const sourceValue = source[key];\n    if (sourceValue !== null && typeof sourceValue === \"object\" && !Array.isArray(sourceValue)) {\n      const targetValue = result[key];\n      const targetObject = targetValue && typeof targetValue === \"object\" && !Array.isArray(targetValue) ? targetValue : {};\n      result[key] = deepMerge(targetObject, sourceValue);\n    } else {\n      result[key] = sourceValue;\n    }\n  });\n  return result;\n};\nconst updateMetadata = (file, metadata) => {\n  const merged = deepMerge(file, metadata);\n  Object.assign(file, merged);\n  file.originalName = extractOriginalName(file.metadata) || file.originalName;\n};\n\nconst defaults = {\n  allowMIME: [\"*/*\"],\n  filename: ({ id }) => id,\n  maxMetadataSize: \"8MB\",\n  maxUploadSize: \"5TB\",\n  onComplete: () => {\n  },\n  onCreate: () => {\n  },\n  onDelete: () => {\n  },\n  onError: () => {\n  },\n  onUpdate: () => {\n  },\n  useRelativeLocation: false,\n  validation: {}\n};\nconst defaultCloudStorageFileNameValidation = (name) => {\n  if (!name || name.length < 3 || name.length > 255 || isAbsolute(name)) {\n    return false;\n  }\n  const upperCase = name.toUpperCase();\n  return !(upperCase.includes(\"../\") || name.includes(\"\\0\"));\n};\nconst defaultFilesystemFileNameValidation = (name) => {\n  if (!name || name.length < 3 || name.length > 255 || isAbsolute(name)) {\n    return false;\n  }\n  const upperCase = name.toUpperCase();\n  const filesystemInvalidChars = ['\"', \"*\", \":\", \"<\", \">\", \"?\", \"\\\\\", \"|\", \"../\", \"\\0\"];\n  return !filesystemInvalidChars.some((char) => upperCase.includes(char));\n};\nclass BaseStorage {\n  /**\n   * Hook called when a new file is created.\n   * @param file The newly created file object.\n   * @remarks This hook is called after file metadata is saved but before returning the file.\n   * Can be used for side effects like logging, notifications, or custom processing.\n   */\n  onCreate;\n  /**\n   * Hook called when file metadata is updated.\n   * @param file The updated file object.\n   * @remarks This hook is called after metadata is updated and saved.\n   * Can be used for side effects like logging or custom processing.\n   */\n  onUpdate;\n  /**\n   * Hook called when a file upload is completed.\n   * @param file The completed file object.\n   * @param response The response object that can be modified in place (headers, statusCode, body).\n   * @param request Optional request object for additional context.\n   * @remarks This hook is called when file status becomes \"completed\".\n   * The response object can be modified directly to add headers or change the status code.\n   */\n  onComplete;\n  /**\n   * Hook called when a file is deleted.\n   * @param file The deleted file object.\n   * @remarks This hook is called after the file is deleted but before returning.\n   * Can be used for side effects like cleanup or logging.\n   */\n  onDelete;\n  /**\n   * Hook called when an error occurs during storage operations.\n   * @param error The HTTP error object that can be modified in place.\n   * @remarks This hook allows customizing error responses by modifying the error object.\n   * The error object can be modified to change headers, statusCode, or body properties.\n   * Error formatting happens in handlers after this hook is called.\n   */\n  onError;\n  isReady = true;\n  errorResponses = {};\n  cache;\n  logger;\n  metrics;\n  genericConfig;\n  maxMetadataSize;\n  checksumTypes = [];\n  maxUploadSize;\n  expiration;\n  locker;\n  namingFunction;\n  validation = new Validator();\n  assetFolder = void 0;\n  /**\n   * Limits the number of concurrent upload requests\n   */\n  concurrency;\n  constructor(config) {\n    const options = { ...defaults, ...config };\n    this.onCreate = options.onCreate;\n    this.onUpdate = options.onUpdate;\n    this.onComplete = options.onComplete;\n    this.onDelete = options.onDelete;\n    this.onError = options.onError;\n    this.namingFunction = options.filename;\n    this.maxUploadSize = typeof options.maxUploadSize === \"string\" ? parseBytes(options.maxUploadSize) : options.maxUploadSize;\n    this.maxMetadataSize = typeof options.maxMetadataSize === \"string\" ? parseBytes(options.maxMetadataSize) : options.maxMetadataSize;\n    this.expiration = options.expiration;\n    this.genericConfig = options;\n    if (options.assetFolder !== void 0) {\n      this.assetFolder = normalize(options.assetFolder);\n    }\n    this.locker = new Locker({\n      max: 1e3,\n      ttl: 3e4,\n      ttlAutopurge: true\n    });\n    this.cache = options.cache ?? new NoOpCache();\n    this.logger = options.logger;\n    this.metrics = options.metrics ?? new NoOpMetrics();\n    this.logger?.debug(`${this.constructor.name} config: ${inspect({ ...config, logger: this.logger.constructor })}`);\n    const purgeInterval = toMilliseconds(options.expiration?.purgeInterval);\n    if (purgeInterval) {\n      this.startAutoPurge(purgeInterval);\n    }\n    const size = {\n      isValid(file) {\n        if (file.size === void 0) {\n          return true;\n        }\n        const fileSize = Number(file.size);\n        if (fileSize < 0) {\n          return false;\n        }\n        return fileSize <= this.value;\n      },\n      response: ErrorMap.RequestEntityTooLarge,\n      value: this.maxUploadSize\n    };\n    const mime = {\n      isValid(file) {\n        return !!typeis.is(file.contentType, this.value);\n      },\n      // @TODO: add better error handling for mime types\n      response: ErrorMap.UnsupportedMediaType,\n      value: options.allowMIME\n    };\n    const fileNameValidation = options.fileNameValidation ?? defaultCloudStorageFileNameValidation;\n    const filename = {\n      isValid(file) {\n        return fileNameValidation(file.name);\n      },\n      response: ErrorMap.InvalidFileName\n    };\n    this.validation.add({ filename, mime, size });\n    this.validation.add({ ...options.validation });\n  }\n  get tusExtension() {\n    const extensions = [\"creation\", \"creation-with-upload\", \"termination\", \"checksum\", \"creation-defer-length\", \"concatenation\"];\n    if (this.expiration) {\n      extensions.push(\"expiration\");\n    }\n    return extensions;\n  }\n  /**\n   * Validates a file against configured validation rules.\n   * @param file File object to validate.\n   * @returns Promise resolving to undefined if file is valid, throws ValidationError otherwise.\n   * @throws {ValidationError} If validation fails\n   */\n  async validate(file) {\n    await this.validation.verify(file);\n  }\n  /**\n   * Checks if a file exists by querying its metadata.\n   * @param query File query containing the file ID to check.\n   * @param query.id File ID to check.\n   * @returns Promise resolving to true if file exists, false otherwise.\n   * @remarks This method does not throw errors - it returns false if the file is not found.\n   */\n  async exists(query) {\n    return this.instrumentOperation(\"exists\", async () => {\n      try {\n        await this.getMeta(query.id);\n        return true;\n      } catch {\n        return false;\n      }\n    });\n  }\n  /**\n   * Normalizes errors with storage-specific context.\n   * @param error The error to normalize.\n   * @returns Normalized HTTP error with storage class context added to the message.\n   * @remarks Errors are enhanced with the storage class name for better debugging.\n   */\n  normalizeError(error) {\n    const baseError = {\n      code: error.name,\n      message: error.message,\n      name: error.name,\n      statusCode: 500\n    };\n    return {\n      ...baseError,\n      message: `[${this.constructor.name}] ${baseError.message}`\n    };\n  }\n  /**\n   * Gets the storage configuration.\n   * @returns The current storage configuration options.\n   */\n  get config() {\n    return this.genericConfig;\n  }\n  /**\n   * Saves upload metadata to the metadata storage.\n   * @param file File object containing metadata to save.\n   * @returns Promise resolving to the saved file object.\n   * @remarks Updates timestamps and caches the file metadata.\n   */\n  async saveMeta(file) {\n    this.updateTimestamps(file);\n    this.cache.set(file.id, file);\n    return this.meta.save(file.id, file);\n  }\n  /**\n   * Deletes upload metadata from the metadata storage.\n   * @param id File ID whose metadata should be deleted.\n   * @returns Promise resolving when metadata is deleted.\n   * @remarks Also removes the file from the cache.\n   */\n  async deleteMeta(id) {\n    this.cache.delete(id);\n    return this.meta.delete(id);\n  }\n  /**\n   * Retrieves upload metadata by file ID.\n   * @param id File ID to retrieve metadata for.\n   * @returns Promise resolving to the file metadata object.\n   * @throws {UploadError} If the file metadata cannot be found (ERRORS.FILE_NOT_FOUND).\n   * @remarks Caches the retrieved metadata for faster subsequent access.\n   */\n  async getMeta(id) {\n    try {\n      const file = await this.meta.get(id);\n      this.cache.set(file.id, file);\n      return { ...file };\n    } catch {\n      return throwErrorCode(ERRORS.FILE_NOT_FOUND);\n    }\n  }\n  /**\n   * Checks if a file has expired and deletes it if so.\n   * @param file File object to check for expiration.\n   * @returns Promise resolving to the file object if not expired.\n   * @throws {UploadError} If the file has expired (ERRORS.GONE).\n   * @remarks If the file is expired, it is automatically deleted and the metadata is removed.\n   */\n  async checkIfExpired(file) {\n    if (isExpired(file)) {\n      void this.delete(file).catch(() => void 0);\n      void this.deleteMeta(file.id).catch(() => void 0);\n      return throwErrorCode(ERRORS.GONE);\n    }\n    return file;\n  }\n  /**\n   * Searches for and purges expired uploads.\n   * @param maxAge Maximum age of files to keep (files older than this will be purged).\n   * Can be a number (milliseconds) or string (e.g., \"1h\", \"30m\", \"7d\").\n   * If not provided, uses the expiration.maxAge from configuration.\n   * @returns Promise resolving to a list of purged files.\n   * @remarks\n   * Errors during individual file deletions are logged but do not stop the purge process.\n   * Files with corrupted metadata are skipped with a warning.\n   * Uses rolling expiration if configured (based on modifiedAt) or fixed expiration (based on createdAt).\n   */\n  async purge(maxAge) {\n    return this.instrumentOperation(\"purge\", async () => {\n      const maxAgeMs = toMilliseconds(maxAge || this.expiration?.maxAge);\n      const purged = { items: [], maxAgeMs };\n      if (maxAgeMs) {\n        const before = Date.now() - maxAgeMs;\n        const list = await this.list();\n        const expired = list.filter(\n          (item) => Number(new Date(this.expiration?.rolling ? item.modifiedAt || item.createdAt : item.createdAt)) < before\n        );\n        for await (const { id, ...rest } of expired) {\n          try {\n            const deleted = await this.delete({ id });\n            purged.items.push({ ...deleted, ...rest });\n          } catch (error) {\n            this.logger?.warn(`Failed to delete file ${id} during purge: ${error instanceof Error ? error.message : String(error)}`);\n          }\n        }\n        if (purged.items.length > 0) {\n          this.logger?.info(`Purge: removed ${purged.items.length} uploads`);\n          this.metrics.gauge(\"storage.operations.purge.items_count\", purged.items.length, {\n            storage: this.constructor.name.toLowerCase().replace(\"storage\", \"\")\n          });\n        }\n      }\n      return purged;\n    });\n  }\n  /**\n   * Gets an uploaded file as a readable stream for efficient large file handling.\n   * @param query File query containing the file ID to stream.\n   * @param query.id File ID to stream.\n   * @returns Promise resolving to an object containing the stream, headers, and size.\n   * @throws {UploadError} If the file cannot be found (ERRORS.FILE_NOT_FOUND) or has expired (ERRORS.GONE).\n   * @remarks\n   * Default implementation falls back to get() and creates a stream from the buffer.\n   * Storage implementations should override this for better streaming performance.\n   * Headers include Content-Type, Content-Length, ETag, and Last-Modified.\n   */\n  async getStream({ id }) {\n    return this.instrumentOperation(\"getStream\", async () => {\n      const file = await this.get({ id });\n      const stream = Readable.from(file.content);\n      return {\n        headers: {\n          \"Content-Length\": String(file.size),\n          \"Content-Type\": file.contentType,\n          ...file.ETag && { ETag: file.ETag },\n          ...file.modifiedAt && { \"Last-Modified\": file.modifiedAt.toString() }\n        },\n        size: typeof file.size === \"number\" ? file.size : void 0,\n        stream\n      };\n    });\n  }\n  /**\n   * Retrieves a list of uploaded files.\n   * @param _limit Maximum number of files to return (default: 1000).\n   * @returns Promise resolving to an array of file metadata objects.\n   * @throws {Error} If not implemented by the storage backend.\n   * @remarks Storage implementations must override this method.\n   */\n  async list(_limit = 1e3) {\n    return this.instrumentOperation(\"list\", async () => {\n      throw new Error(\"Not implemented\");\n    });\n  }\n  /**\n   * Updates file metadata with user-provided key-value pairs.\n   * @param query File query containing the file ID to update.\n   * @param query.id File ID to update.\n   * @param metadata Partial file object containing fields to update.\n   * @returns Promise resolving to the updated file object.\n   * @throws {UploadError} If the file cannot be found (ERRORS.FILE_NOT_FOUND).\n   * @remarks\n   * Supports TTL (time-to-live) option: if metadata contains a 'ttl' field,\n   * it will be converted to an 'expiredAt' timestamp.\n   * TTL can be a number (milliseconds) or string (e.g., \"1h\", \"30m\", \"7d\").\n   */\n  async update({ id }, metadata) {\n    return this.instrumentOperation(\"update\", async () => {\n      const file = await this.getMeta(id);\n      const processedMetadata = { ...metadata };\n      if (\"ttl\" in processedMetadata && processedMetadata.ttl !== void 0) {\n        const ttlValue = processedMetadata.ttl;\n        const ttlMs = typeof ttlValue === \"string\" ? toMilliseconds(ttlValue) : ttlValue;\n        if (ttlMs !== void 0) {\n          processedMetadata.expiredAt = Date.now() + ttlMs;\n        }\n        delete processedMetadata.ttl;\n      }\n      updateMetadata(file, processedMetadata);\n      await this.saveMeta(file);\n      const updatedFile = { ...file, status: \"updated\" };\n      await this.onUpdate(updatedFile);\n      return updatedFile;\n    });\n  }\n  /**\n   * Deletes multiple files in a single batch operation.\n   * @param ids Array of file IDs to delete.\n   * @returns Promise resolving to batch operation response with successful and failed deletions.\n   * @remarks\n   * Processes all deletions in parallel using Promise.allSettled.\n   * Individual failures do not stop the batch operation.\n   * Each deletion is wrapped in error handling to capture failures.\n   * Metrics are recorded for the batch operation and individual failures.\n   * Returns both successful and failed operations with detailed error information.\n   */\n  async deleteBatch(ids) {\n    const startTime = Date.now();\n    const storageType = this.constructor.name.toLowerCase().replace(\"storage\", \"\");\n    this.metrics.increment(\"storage.operations.batch.delete.count\", 1, {\n      batch_size: ids.length,\n      storage: storageType\n    });\n    const successful = [];\n    const failed = [];\n    const deletePromises = ids.map(async (id) => {\n      try {\n        const file = await this.delete({ id });\n        return { file, id, success: true };\n      } catch (error) {\n        const errorMessage = error instanceof Error ? error.message : \"Delete failed\";\n        this.metrics.increment(\"storage.operations.delete.error.count\", 1, {\n          error: errorMessage,\n          storage: storageType\n        });\n        return { error: errorMessage, id, success: false };\n      }\n    });\n    const results = await Promise.allSettled(deletePromises);\n    for (const result of results) {\n      if (result.status === \"fulfilled\") {\n        if (result.value.success) {\n          successful.push(result.value.file);\n        } else {\n          failed.push({ error: result.value.error, id: result.value.id });\n        }\n      } else {\n        failed.push({ error: result.reason?.message || \"Delete failed\", id: \"\" });\n      }\n    }\n    const duration = Date.now() - startTime;\n    this.metrics.timing(\"storage.operations.batch.delete.duration\", duration, {\n      batch_size: ids.length,\n      storage: storageType\n    });\n    this.metrics.gauge(\"storage.operations.batch.delete.success_count\", successful.length, {\n      storage: storageType\n    });\n    this.metrics.gauge(\"storage.operations.batch.delete.failed_count\", failed.length, {\n      storage: storageType\n    });\n    return {\n      failed,\n      failedCount: failed.length,\n      successful,\n      successfulCount: successful.length\n    };\n  }\n  /**\n   * Copies multiple files in a single batch operation.\n   * @param operations Array of copy operations, each containing:\n   * source: Source file ID.\n   * destination: Destination file ID or path.\n   * options: Optional copy options including storage class.\n   * @returns Promise resolving to batch operation response with successful and failed copies.\n   * @remarks\n   * Processes all copies in parallel using Promise.allSettled.\n   * Individual failures do not stop the batch operation.\n   * Each copy operation is wrapped in error handling to capture failures.\n   * Metrics are recorded for the batch operation and individual failures.\n   * Returns both successful and failed operations with detailed error information.\n   */\n  async copyBatch(operations) {\n    const startTime = Date.now();\n    const storageType = this.constructor.name.toLowerCase().replace(\"storage\", \"\");\n    this.metrics.increment(\"storage.operations.batch.copy.count\", 1, {\n      batch_size: operations.length,\n      storage: storageType\n    });\n    const successful = [];\n    const failed = [];\n    const copyPromises = operations.map(async ({ destination, options, source }) => {\n      try {\n        const copiedFile = await this.copy(source, destination, options);\n        return { file: copiedFile, id: destination, success: true };\n      } catch (error) {\n        const errorMessage = error instanceof Error ? error.message : \"Copy failed\";\n        this.metrics.increment(\"storage.operations.copy.error.count\", 1, {\n          error: errorMessage,\n          storage: storageType\n        });\n        return { error: errorMessage, id: destination, success: false };\n      }\n    });\n    const results = await Promise.allSettled(copyPromises);\n    for (const result of results) {\n      if (result.status === \"fulfilled\") {\n        if (result.value.success && result.value.file) {\n          successful.push(result.value.file);\n        } else {\n          failed.push({ error: result.value.error || \"Copy failed\", id: result.value.id });\n        }\n      } else {\n        failed.push({ error: result.reason?.message || \"Copy failed\", id: \"\" });\n      }\n    }\n    const duration = Date.now() - startTime;\n    this.metrics.timing(\"storage.operations.batch.copy.duration\", duration, {\n      batch_size: operations.length,\n      storage: storageType\n    });\n    this.metrics.gauge(\"storage.operations.batch.copy.success_count\", successful.length, {\n      storage: storageType\n    });\n    this.metrics.gauge(\"storage.operations.batch.copy.failed_count\", failed.length, {\n      storage: storageType\n    });\n    return {\n      failed,\n      failedCount: failed.length,\n      successful,\n      successfulCount: successful.length\n    };\n  }\n  /**\n   * Moves multiple files in a single batch operation.\n   * @param operations Array of move operations, each containing:\n   * source: Source file ID.\n   * destination: Destination file ID or path.\n   * @returns Promise resolving to batch operation response with successful and failed moves.\n   * @remarks\n   * Processes all moves in parallel using Promise.allSettled.\n   * Individual failures do not stop the batch operation.\n   * Each move operation is wrapped in error handling to capture failures.\n   * Metrics are recorded for the batch operation and individual failures.\n   * Returns both successful and failed operations with detailed error information.\n   */\n  async moveBatch(operations) {\n    const startTime = Date.now();\n    const storageType = this.constructor.name.toLowerCase().replace(\"storage\", \"\");\n    this.metrics.increment(\"storage.operations.batch.move.count\", 1, {\n      batch_size: operations.length,\n      storage: storageType\n    });\n    const successful = [];\n    const failed = [];\n    const movePromises = operations.map(async ({ destination, source }) => {\n      try {\n        const movedFile = await this.move(source, destination);\n        return { file: movedFile, id: destination, success: true };\n      } catch (error) {\n        const errorMessage = error instanceof Error ? error.message : \"Move failed\";\n        this.metrics.increment(\"storage.operations.move.error.count\", 1, {\n          error: errorMessage,\n          storage: storageType\n        });\n        return { error: errorMessage, id: destination, success: false };\n      }\n    });\n    const results = await Promise.allSettled(movePromises);\n    for (const result of results) {\n      if (result.status === \"fulfilled\") {\n        if (result.value.success && result.value.file) {\n          successful.push(result.value.file);\n        } else {\n          failed.push({ error: result.value.error || \"Move failed\", id: result.value.id });\n        }\n      } else {\n        failed.push({ error: result.reason?.message || \"Move failed\", id: result.reason?.id || \"\" });\n      }\n    }\n    const duration = Date.now() - startTime;\n    this.metrics.timing(\"storage.operations.batch.move.duration\", duration, {\n      batch_size: operations.length,\n      storage: storageType\n    });\n    this.metrics.gauge(\"storage.operations.batch.move.success_count\", successful.length, {\n      storage: storageType\n    });\n    this.metrics.gauge(\"storage.operations.batch.move.failed_count\", failed.length, {\n      storage: storageType\n    });\n    return {\n      failed,\n      failedCount: failed.length,\n      successful,\n      successfulCount: successful.length\n    };\n  }\n  /**\n   * Prevent upload from being accessed by multiple requests\n   */\n  async lock(key) {\n    const activeUploads = [...this.locker.keys()];\n    if (activeUploads.includes(key)) {\n      return throwErrorCode(ERRORS.FILE_LOCKED);\n    }\n    if (this.config.concurrency && typeof this.config.concurrency === \"number\" && this.config.concurrency < activeUploads.length) {\n      return throwErrorCode(ERRORS.STORAGE_BUSY);\n    }\n    this.locker.set(key, key);\n    return key;\n  }\n  async unlock(key) {\n    this.locker.unlock(key);\n  }\n  isUnsupportedChecksum(algorithm = \"\") {\n    return !!algorithm && !this.checksumTypes.includes(algorithm);\n  }\n  startAutoPurge(purgeInterval) {\n    if (purgeInterval >= 2147483647) {\n      throw new Error(\"purgeInterval must be less than 2147483647 ms\");\n    }\n    setInterval(() => void this.purge().catch((error) => this.logger?.error(error)), purgeInterval);\n  }\n  updateTimestamps(file) {\n    file.createdAt ??= (/* @__PURE__ */ new Date()).toISOString();\n    const maxAgeMs = toMilliseconds(this.expiration?.maxAge);\n    if (maxAgeMs && !file.expiredAt) {\n      file.expiredAt = this.expiration?.rolling ? Date.now() + maxAgeMs : +new Date(file.createdAt) + maxAgeMs;\n    }\n    return file;\n  }\n  /**\n   * Instruments a storage operation with metrics and error tracking.\n   * @param operation Operation name (e.g., \"create\", \"delete\", \"copy\").\n   * @param function_ The operation function to execute.\n   * @param attributes Additional attributes to include in metrics.\n   * @returns Promise resolving to the operation result.\n   * @throws Re-throws any errors from the operation function.\n   * @remarks\n   * Records operation count, duration, and error metrics.\n   * Tracks file sizes for operations returning file objects.\n   * Error metrics include error messages for debugging.\n   * All public methods should use this wrapper for consistent instrumentation.\n   */\n  async instrumentOperation(operation, function_, attributes) {\n    const startTime = Date.now();\n    const storageType = this.constructor.name.toLowerCase().replace(\"storage\", \"\");\n    const baseAttributes = {\n      storage: storageType,\n      ...attributes\n    };\n    try {\n      this.metrics.increment(`storage.operations.${operation}.count`, 1, baseAttributes);\n      const result = await function_();\n      const duration = Date.now() - startTime;\n      this.metrics.timing(`storage.operations.${operation}.duration`, duration, baseAttributes);\n      if (result && typeof result === \"object\" && \"size\" in result && typeof result.size === \"number\") {\n        this.metrics.gauge(\"storage.files.size\", result.size, {\n          ...baseAttributes,\n          operation\n        });\n      }\n      return result;\n    } catch (error) {\n      const duration = Date.now() - startTime;\n      const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n      this.metrics.timing(`storage.operations.${operation}.duration`, duration, {\n        ...baseAttributes,\n        error: \"true\"\n      });\n      this.metrics.increment(`storage.operations.${operation}.error.count`, 1, {\n        ...baseAttributes,\n        error: errorMessage\n      });\n      throw error;\n    }\n  }\n}\n\nexport { BaseStorage as B, defaultFilesystemFileNameValidation as a, parseBytes as b, defaultCloudStorageFileNameValidation as d, parseDuration as p, toMilliseconds as t };\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;AAEA,MAAM,aAAa;IACjB,KAAK;QACH;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;KACD;IACD,WAAW;QACT;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;KACD;IACD,QAAQ;QACN;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;KACD;IACD,cAAc;QACZ;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT;QACA;YACE,MAAM;YACN,OAAO;QACT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"}},
    {"offset": {"line": 1988, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage/dist/packem_shared/MetaStorage-pECeFOad.js"],"sourcesContent":["class MetaStorage {\n  prefix = \"\";\n  suffix = \"\";\n  logger;\n  constructor(config) {\n    this.prefix = config?.prefix ?? \"\";\n    this.suffix = config?.suffix ?? \".META\";\n    this.logger = config?.logger;\n  }\n  /**\n   * Saves upload metadata.\n   */\n  // eslint-disable-next-line class-methods-use-this\n  async save(_id, file) {\n    return file;\n  }\n  /**\n   * Deletes an upload metadata.\n   */\n  // eslint-disable-next-line class-methods-use-this\n  async delete(_id) {\n    throw new Error(\"Not implemented\");\n  }\n  /**\n   * Retrieves upload metadata.\n   */\n  // eslint-disable-next-line class-methods-use-this\n  async get(_id) {\n    throw new Error(\"Not implemented\");\n  }\n  /**\n   * Marks upload active.\n   */\n  // eslint-disable-next-line class-methods-use-this\n  async touch(_id, _file) {\n    throw new Error(\"Not implemented\");\n  }\n  getMetaName(id) {\n    return this.prefix + id + this.suffix;\n  }\n  getIdFromMetaName(name) {\n    return name.slice(this.prefix.length, -this.suffix.length);\n  }\n}\n\nexport { MetaStorage as default };\n"],"names":[],"mappings":";;;;AAAA,MAAM;IACJ,SAAS,GAAG;IACZ,SAAS,GAAG;IACZ,OAAO;IACP,YAAY,MAAM,CAAE;QAClB,IAAI,CAAC,MAAM,GAAG,QAAQ,UAAU;QAChC,IAAI,CAAC,MAAM,GAAG,QAAQ,UAAU;QAChC,IAAI,CAAC,MAAM,GAAG,QAAQ;IACxB;IACA;;GAEC,GACD,kDAAkD;IAClD,MAAM,KAAK,GAAG,EAAE,IAAI,EAAE;QACpB,OAAO;IACT;IACA;;GAEC,GACD,kDAAkD;IAClD,MAAM,OAAO,GAAG,EAAE;QAChB,MAAM,IAAI,MAAM;IAClB;IACA;;GAEC,GACD,kDAAkD;IAClD,MAAM,IAAI,GAAG,EAAE;QACb,MAAM,IAAI,MAAM;IAClB;IACA;;GAEC,GACD,kDAAkD;IAClD,MAAM,MAAM,GAAG,EAAE,KAAK,EAAE;QACtB,MAAM,IAAI,MAAM;IAClB;IACA,YAAY,EAAE,EAAE;QACd,OAAO,IAAI,CAAC,MAAM,GAAG,KAAK,IAAI,CAAC,MAAM;IACvC;IACA,kBAAkB,IAAI,EAAE;QACtB,OAAO,KAAK,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM;IAC3D;AACF"}},
    {"offset": {"line": 2037, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage/dist/packem_shared/Metadata-v9haqHC6.js"],"sourcesContent":["const isRecord = (x) => x !== null && typeof x === \"object\" && !Array.isArray(x);\n\nconst ASCII_SPACE = \" \".codePointAt(0) ?? 32;\nconst ASCII_COMMA = \",\".codePointAt(0) ?? 44;\nconst BASE64_REGEX = /^[\\d+/A-Z]*={0,2}$/i;\nconst isNumeric = (input) => {\n  if (typeof input !== \"string\") {\n    return false;\n  }\n  const number_ = Number.parseFloat(input);\n  return !Number.isNaN(number_) && isFinite(number_);\n};\nclass Metadata {\n  psize;\n  pname;\n  pfiletype;\n  ptype;\n  pmimeType;\n  pcontentType;\n  ptitle;\n  pfilename;\n  poriginalName;\n  plastModified;\n}\nconst isMetadata = (raw) => isRecord(raw);\nconst validateKey = (key) => {\n  if (key.length === 0) {\n    return false;\n  }\n  for (let index = 0; index < key.length; ++index) {\n    const charCodePoint = key.codePointAt(index);\n    if (charCodePoint > 127 || charCodePoint === ASCII_SPACE || charCodePoint === ASCII_COMMA) {\n      return false;\n    }\n  }\n  return true;\n};\nconst validateValue = (value) => {\n  if (value.length % 4 !== 0) {\n    return false;\n  }\n  return BASE64_REGEX.test(value);\n};\nconst stringifyMetadata = (metadata) => Object.entries(metadata).map(([key, value]) => {\n  if (value === null || value === void 0) {\n    return key;\n  }\n  const stringValue = typeof value === \"object\" ? JSON.stringify(value) : String(value);\n  const encodedValue = Buffer.from(stringValue, \"utf8\").toString(\"base64\");\n  return `${key} ${encodedValue}`;\n}).join(\",\");\nconst parseMetadata = (string_) => {\n  const meta = {};\n  if (!string_ || string_.trim().length === 0) {\n    throw new Error(\"Metadata string is not valid\");\n  }\n  for (const pair of string_.split(\",\")) {\n    const tokens = pair.split(\" \");\n    const [key, value] = tokens;\n    if ((tokens.length === 1 || tokens.length === 2) && validateKey(key) && (tokens.length === 1 || validateValue(value)) && !(key in meta)) {\n      const decodedValue = tokens.length === 1 ? void 0 : value ? Buffer.from(value, \"base64\").toString(\"utf8\") : \"\";\n      let parsedValue = decodedValue;\n      if (decodedValue !== void 0) {\n        try {\n          parsedValue = JSON.parse(decodedValue);\n        } catch {\n          if (decodedValue === \"true\") {\n            parsedValue = true;\n          } else if (decodedValue === \"false\") {\n            parsedValue = false;\n          } else if (isNumeric(decodedValue)) {\n            parsedValue = Number(decodedValue);\n          }\n        }\n      }\n      meta[key] = parsedValue;\n    } else {\n      throw new Error(\"Metadata string is not valid\");\n    }\n  }\n  return meta;\n};\n\nexport { Metadata, isMetadata, parseMetadata, stringifyMetadata, validateKey, validateValue };\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA,MAAM,WAAW,CAAC,IAAM,MAAM,QAAQ,OAAO,MAAM,YAAY,CAAC,MAAM,OAAO,CAAC;AAE9E,MAAM,cAAc,IAAI,WAAW,CAAC,MAAM;AAC1C,MAAM,cAAc,IAAI,WAAW,CAAC,MAAM;AAC1C,MAAM,eAAe;AACrB,MAAM,YAAY,CAAC;IACjB,IAAI,OAAO,UAAU,UAAU;QAC7B,OAAO;IACT;IACA,MAAM,UAAU,OAAO,UAAU,CAAC;IAClC,OAAO,CAAC,OAAO,KAAK,CAAC,YAAY,SAAS;AAC5C;AACA,MAAM;IACJ,MAAM;IACN,MAAM;IACN,UAAU;IACV,MAAM;IACN,UAAU;IACV,aAAa;IACb,OAAO;IACP,UAAU;IACV,cAAc;IACd,cAAc;AAChB;AACA,MAAM,aAAa,CAAC,MAAQ,SAAS;AACrC,MAAM,cAAc,CAAC;IACnB,IAAI,IAAI,MAAM,KAAK,GAAG;QACpB,OAAO;IACT;IACA,IAAK,IAAI,QAAQ,GAAG,QAAQ,IAAI,MAAM,EAAE,EAAE,MAAO;QAC/C,MAAM,gBAAgB,IAAI,WAAW,CAAC;QACtC,IAAI,gBAAgB,OAAO,kBAAkB,eAAe,kBAAkB,aAAa;YACzF,OAAO;QACT;IACF;IACA,OAAO;AACT;AACA,MAAM,gBAAgB,CAAC;IACrB,IAAI,MAAM,MAAM,GAAG,MAAM,GAAG;QAC1B,OAAO;IACT;IACA,OAAO,aAAa,IAAI,CAAC;AAC3B;AACA,MAAM,oBAAoB,CAAC,WAAa,OAAO,OAAO,CAAC,UAAU,GAAG,CAAC,CAAC,CAAC,KAAK,MAAM;QAChF,IAAI,UAAU,QAAQ,UAAU,KAAK,GAAG;YACtC,OAAO;QACT;QACA,MAAM,cAAc,OAAO,UAAU,WAAW,KAAK,SAAS,CAAC,SAAS,OAAO;QAC/E,MAAM,eAAe,OAAO,IAAI,CAAC,aAAa,QAAQ,QAAQ,CAAC;QAC/D,OAAO,GAAG,IAAI,CAAC,EAAE,cAAc;IACjC,GAAG,IAAI,CAAC;AACR,MAAM,gBAAgB,CAAC;IACrB,MAAM,OAAO,CAAC;IACd,IAAI,CAAC,WAAW,QAAQ,IAAI,GAAG,MAAM,KAAK,GAAG;QAC3C,MAAM,IAAI,MAAM;IAClB;IACA,KAAK,MAAM,QAAQ,QAAQ,KAAK,CAAC,KAAM;QACrC,MAAM,SAAS,KAAK,KAAK,CAAC;QAC1B,MAAM,CAAC,KAAK,MAAM,GAAG;QACrB,IAAI,CAAC,OAAO,MAAM,KAAK,KAAK,OAAO,MAAM,KAAK,CAAC,KAAK,YAAY,QAAQ,CAAC,OAAO,MAAM,KAAK,KAAK,cAAc,MAAM,KAAK,CAAC,CAAC,OAAO,IAAI,GAAG;YACvI,MAAM,eAAe,OAAO,MAAM,KAAK,IAAI,KAAK,IAAI,QAAQ,OAAO,IAAI,CAAC,OAAO,UAAU,QAAQ,CAAC,UAAU;YAC5G,IAAI,cAAc;YAClB,IAAI,iBAAiB,KAAK,GAAG;gBAC3B,IAAI;oBACF,cAAc,KAAK,KAAK,CAAC;gBAC3B,EAAE,OAAM;oBACN,IAAI,iBAAiB,QAAQ;wBAC3B,cAAc;oBAChB,OAAO,IAAI,iBAAiB,SAAS;wBACnC,cAAc;oBAChB,OAAO,IAAI,UAAU,eAAe;wBAClC,cAAc,OAAO;oBACvB;gBACF;YACF;YACA,IAAI,CAAC,IAAI,GAAG;QACd,OAAO;YACL,MAAM,IAAI,MAAM;QAClB;IACF;IACA,OAAO;AACT"}},
    {"offset": {"line": 2143, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage/dist/packem_shared/local-meta-storage-CsuVst9V.js"],"sourcesContent":["import { utimes } from 'node:fs/promises';\nimport { tmpdir } from 'node:os';\nimport { throwErrorCode, ERRORS } from './ERRORS-DKaR93nv.js';\nimport MetaStorage from './MetaStorage-pECeFOad.js';\nimport { stringifyMetadata, parseMetadata } from './Metadata-v9haqHC6.js';\nimport { a as normalizeWindowsPath, d as dirname, n as normalize, j as join } from './path-CR6YkPXX-7R1-9CMk.js';\nimport { createRequire } from 'node:module';\n\nconst F_OK = 0;\nconst R_OK = 4;\n\nconst assertValidFileOrDirectoryPath = (fileOrDirectoryPath) => {\n  if (!fileOrDirectoryPath || !(fileOrDirectoryPath instanceof URL) && typeof fileOrDirectoryPath !== \"string\") {\n    throw new TypeError(\"Path must be a non-empty string or URL.\");\n  }\n};\n\nconst getFileInfoType = (fileInfo) => {\n  if (fileInfo.isFile()) {\n    return \"file\";\n  }\n  if (fileInfo.isDirectory()) {\n    return \"dir\";\n  }\n  if (fileInfo.isSymbolicLink()) {\n    return \"symlink\";\n  }\n  return void 0;\n};\n\nconst __cjs_require$5 = createRequire(import.meta.url);\nconst __cjs_getProcess$5 = typeof globalThis !== \"undefined\" && typeof globalThis.process !== \"undefined\" ? globalThis.process : process;\nconst __cjs_getBuiltinModule$5 = (module) => {\n  if (typeof __cjs_getProcess$5 !== \"undefined\" && __cjs_getProcess$5.versions && __cjs_getProcess$5.versions.node) {\n    const [major, minor] = __cjs_getProcess$5.versions.node.split(\".\").map(Number);\n    if (major > 22 || major === 22 && minor >= 3 || major === 20 && minor >= 16) {\n      return __cjs_getProcess$5.getBuiltinModule(module);\n    }\n  }\n  return __cjs_require$5(module);\n};\nconst {\n  lstat,\n  mkdir: mkdir$1\n} = __cjs_getBuiltinModule$5(\"node:fs/promises\");\nconst ensureDir = async (directory) => {\n  assertValidFileOrDirectoryPath(directory);\n  try {\n    const fileInfo = await lstat(directory);\n    if (!fileInfo.isDirectory()) {\n      throw new Error(`Ensure path exists, expected 'dir', got '${getFileInfoType(fileInfo)}'`);\n    }\n    return;\n  } catch (error) {\n    if (error.code !== \"ENOENT\") {\n      throw error;\n    }\n  }\n  try {\n    await mkdir$1(directory, { recursive: true });\n  } catch (error) {\n    if (error.code !== \"EEXIST\") {\n      throw error;\n    }\n    const fileInfo = await lstat(directory);\n    if (!fileInfo.isDirectory()) {\n      throw new Error(`Ensure path exists, expected 'dir', got '${getFileInfoType(fileInfo)}'`);\n    }\n  }\n};\n\nconst __cjs_require$4 = createRequire(import.meta.url);\nconst __cjs_getProcess$4 = typeof globalThis !== \"undefined\" && typeof globalThis.process !== \"undefined\" ? globalThis.process : process;\nconst __cjs_getBuiltinModule$4 = (module) => {\n  if (typeof __cjs_getProcess$4 !== \"undefined\" && __cjs_getProcess$4.versions && __cjs_getProcess$4.versions.node) {\n    const [major, minor] = __cjs_getProcess$4.versions.node.split(\".\").map(Number);\n    if (major > 22 || major === 22 && minor >= 3 || major === 20 && minor >= 16) {\n      return __cjs_getProcess$4.getBuiltinModule(module);\n    }\n  }\n  return __cjs_require$4(module);\n};\nconst {\n  fileURLToPath\n} = __cjs_getBuiltinModule$4(\"node:url\");\nfunction getDefaultExportFromCjs(x) {\n  return x && x.__esModule && Object.prototype.hasOwnProperty.call(x, \"default\") ? x[\"default\"] : x;\n}\nvar binaryExtensions$1;\nvar hasRequiredBinaryExtensions;\nfunction requireBinaryExtensions() {\n  if (hasRequiredBinaryExtensions) return binaryExtensions$1;\n  hasRequiredBinaryExtensions = 1;\n  binaryExtensions$1 = [\n    \"3dm\",\n    \"3ds\",\n    \"3g2\",\n    \"3gp\",\n    \"7z\",\n    \"a\",\n    \"aac\",\n    \"adp\",\n    \"afdesign\",\n    \"afphoto\",\n    \"afpub\",\n    \"ai\",\n    \"aif\",\n    \"aiff\",\n    \"alz\",\n    \"ape\",\n    \"apk\",\n    \"appimage\",\n    \"ar\",\n    \"arj\",\n    \"asf\",\n    \"au\",\n    \"avi\",\n    \"bak\",\n    \"baml\",\n    \"bh\",\n    \"bin\",\n    \"bk\",\n    \"bmp\",\n    \"btif\",\n    \"bz2\",\n    \"bzip2\",\n    \"cab\",\n    \"caf\",\n    \"cgm\",\n    \"class\",\n    \"cmx\",\n    \"cpio\",\n    \"cr2\",\n    \"cr3\",\n    \"cur\",\n    \"dat\",\n    \"dcm\",\n    \"deb\",\n    \"dex\",\n    \"djvu\",\n    \"dll\",\n    \"dmg\",\n    \"dng\",\n    \"doc\",\n    \"docm\",\n    \"docx\",\n    \"dot\",\n    \"dotm\",\n    \"dra\",\n    \"DS_Store\",\n    \"dsk\",\n    \"dts\",\n    \"dtshd\",\n    \"dvb\",\n    \"dwg\",\n    \"dxf\",\n    \"ecelp4800\",\n    \"ecelp7470\",\n    \"ecelp9600\",\n    \"egg\",\n    \"eol\",\n    \"eot\",\n    \"epub\",\n    \"exe\",\n    \"f4v\",\n    \"fbs\",\n    \"fh\",\n    \"fla\",\n    \"flac\",\n    \"flatpak\",\n    \"fli\",\n    \"flv\",\n    \"fpx\",\n    \"fst\",\n    \"fvt\",\n    \"g3\",\n    \"gh\",\n    \"gif\",\n    \"graffle\",\n    \"gz\",\n    \"gzip\",\n    \"h261\",\n    \"h263\",\n    \"h264\",\n    \"icns\",\n    \"ico\",\n    \"ief\",\n    \"img\",\n    \"ipa\",\n    \"iso\",\n    \"jar\",\n    \"jpeg\",\n    \"jpg\",\n    \"jpgv\",\n    \"jpm\",\n    \"jxr\",\n    \"key\",\n    \"ktx\",\n    \"lha\",\n    \"lib\",\n    \"lvp\",\n    \"lz\",\n    \"lzh\",\n    \"lzma\",\n    \"lzo\",\n    \"m3u\",\n    \"m4a\",\n    \"m4v\",\n    \"mar\",\n    \"mdi\",\n    \"mht\",\n    \"mid\",\n    \"midi\",\n    \"mj2\",\n    \"mka\",\n    \"mkv\",\n    \"mmr\",\n    \"mng\",\n    \"mobi\",\n    \"mov\",\n    \"movie\",\n    \"mp3\",\n    \"mp4\",\n    \"mp4a\",\n    \"mpeg\",\n    \"mpg\",\n    \"mpga\",\n    \"mxu\",\n    \"nef\",\n    \"npx\",\n    \"numbers\",\n    \"nupkg\",\n    \"o\",\n    \"odp\",\n    \"ods\",\n    \"odt\",\n    \"oga\",\n    \"ogg\",\n    \"ogv\",\n    \"otf\",\n    \"ott\",\n    \"pages\",\n    \"pbm\",\n    \"pcx\",\n    \"pdb\",\n    \"pdf\",\n    \"pea\",\n    \"pgm\",\n    \"pic\",\n    \"png\",\n    \"pnm\",\n    \"pot\",\n    \"potm\",\n    \"potx\",\n    \"ppa\",\n    \"ppam\",\n    \"ppm\",\n    \"pps\",\n    \"ppsm\",\n    \"ppsx\",\n    \"ppt\",\n    \"pptm\",\n    \"pptx\",\n    \"psd\",\n    \"pya\",\n    \"pyc\",\n    \"pyo\",\n    \"pyv\",\n    \"qt\",\n    \"rar\",\n    \"ras\",\n    \"raw\",\n    \"resources\",\n    \"rgb\",\n    \"rip\",\n    \"rlc\",\n    \"rmf\",\n    \"rmvb\",\n    \"rpm\",\n    \"rtf\",\n    \"rz\",\n    \"s3m\",\n    \"s7z\",\n    \"scpt\",\n    \"sgi\",\n    \"shar\",\n    \"snap\",\n    \"sil\",\n    \"sketch\",\n    \"slk\",\n    \"smv\",\n    \"snk\",\n    \"so\",\n    \"stl\",\n    \"suo\",\n    \"sub\",\n    \"swf\",\n    \"tar\",\n    \"tbz\",\n    \"tbz2\",\n    \"tga\",\n    \"tgz\",\n    \"thmx\",\n    \"tif\",\n    \"tiff\",\n    \"tlz\",\n    \"ttc\",\n    \"ttf\",\n    \"txz\",\n    \"udf\",\n    \"uvh\",\n    \"uvi\",\n    \"uvm\",\n    \"uvp\",\n    \"uvs\",\n    \"uvu\",\n    \"viv\",\n    \"vob\",\n    \"war\",\n    \"wav\",\n    \"wax\",\n    \"wbmp\",\n    \"wdp\",\n    \"weba\",\n    \"webm\",\n    \"webp\",\n    \"whl\",\n    \"wim\",\n    \"wm\",\n    \"wma\",\n    \"wmv\",\n    \"wmx\",\n    \"woff\",\n    \"woff2\",\n    \"wrm\",\n    \"wvx\",\n    \"xbm\",\n    \"xif\",\n    \"xla\",\n    \"xlam\",\n    \"xls\",\n    \"xlsb\",\n    \"xlsm\",\n    \"xlsx\",\n    \"xlt\",\n    \"xltm\",\n    \"xltx\",\n    \"xm\",\n    \"xmind\",\n    \"xpi\",\n    \"xpm\",\n    \"xwd\",\n    \"xz\",\n    \"z\",\n    \"zip\",\n    \"zipx\"\n  ];\n  return binaryExtensions$1;\n}\nvar binaryExtensionsExports = /* @__PURE__ */ requireBinaryExtensions();\nconst binaryExtensions = /* @__PURE__ */ getDefaultExportFromCjs(binaryExtensionsExports);\nnew Set(binaryExtensions);\nconst toPath = (urlOrPath) => normalizeWindowsPath(urlOrPath instanceof URL ? fileURLToPath(urlOrPath) : urlOrPath);\n\nconst __cjs_require$3 = createRequire(import.meta.url);\nconst __cjs_getProcess$3 = typeof globalThis !== \"undefined\" && typeof globalThis.process !== \"undefined\" ? globalThis.process : process;\nconst __cjs_getBuiltinModule$3 = (module) => {\n  if (typeof __cjs_getProcess$3 !== \"undefined\" && __cjs_getProcess$3.versions && __cjs_getProcess$3.versions.node) {\n    const [major, minor] = __cjs_getProcess$3.versions.node.split(\".\").map(Number);\n    if (major > 22 || major === 22 && minor >= 3 || major === 20 && minor >= 16) {\n      return __cjs_getProcess$3.getBuiltinModule(module);\n    }\n  }\n  return __cjs_require$3(module);\n};\nconst {\n  access\n} = __cjs_getBuiltinModule$3(\"node:fs/promises\");\nasync function isAccessible(path, mode = F_OK) {\n  assertValidFileOrDirectoryPath(path);\n  path = toPath(path);\n  try {\n    await access(path, mode);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nclass PermissionError extends Error {\n  /**\n   * Creates a new instance.\n   * @param message\n   */\n  constructor(message) {\n    super(`EPERM: Operation not permitted, ${message}`);\n  }\n  // eslint-disable-next-line class-methods-use-this\n  get code() {\n    return \"EPERM\";\n  }\n  // eslint-disable-next-line class-methods-use-this,@typescript-eslint/explicit-module-boundary-types\n  set code(_name) {\n    throw new Error(\"Cannot overwrite code EPERM\");\n  }\n  // eslint-disable-next-line class-methods-use-this\n  get name() {\n    return \"PermissionError\";\n  }\n  // eslint-disable-next-line class-methods-use-this,@typescript-eslint/explicit-module-boundary-types\n  set name(_name) {\n    throw new Error(\"Cannot overwrite name of PermissionError\");\n  }\n}\n\nconst __cjs_require$2 = createRequire(import.meta.url);\nconst __cjs_getProcess$2 = typeof globalThis !== \"undefined\" && typeof globalThis.process !== \"undefined\" ? globalThis.process : process;\nconst __cjs_getBuiltinModule$2 = (module) => {\n  if (typeof __cjs_getProcess$2 !== \"undefined\" && __cjs_getProcess$2.versions && __cjs_getProcess$2.versions.node) {\n    const [major, minor] = __cjs_getProcess$2.versions.node.split(\".\").map(Number);\n    if (major > 22 || major === 22 && minor >= 3 || major === 20 && minor >= 16) {\n      return __cjs_getProcess$2.getBuiltinModule(module);\n    }\n  }\n  return __cjs_require$2(module);\n};\nconst {\n  readFile: readFile$1\n} = __cjs_getBuiltinModule$2(\"node:fs/promises\");\nconst {\n  unzip,\n  brotliDecompress\n} = __cjs_getBuiltinModule$2(\"node:zlib\");\nconst decompressionMethods = {\n  brotli: brotliDecompress,\n  gzip: unzip,\n  none: (buffer, callback) => {\n    callback(null, buffer);\n  }\n};\nconst readFile = async (path, options) => {\n  assertValidFileOrDirectoryPath(path);\n  path = toPath(path);\n  if (!await isAccessible(path)) {\n    throw new PermissionError(`unable to read the non-accessible file: ${path}`);\n  }\n  if (!await isAccessible(path, R_OK)) {\n    throw new Error(`Unable to read the non-readable file: ${path}`);\n  }\n  const { buffer, compression, encoding, flag } = options ?? {};\n  return await readFile$1(path, flag ? { encoding, flag } : { encoding }).then(\n    async (content) => await new Promise((resolve, reject) => {\n      decompressionMethods[compression ?? \"none\"](content, (error, result) => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve(buffer ? result : result.toString());\n        }\n      });\n    })\n  ).catch((error) => {\n    throw error;\n  });\n};\n\nconst __cjs_require$1 = createRequire(import.meta.url);\nconst __cjs_getProcess$1 = typeof globalThis !== \"undefined\" && typeof globalThis.process !== \"undefined\" ? globalThis.process : process;\nconst __cjs_getBuiltinModule$1 = (module) => {\n  if (typeof __cjs_getProcess$1 !== \"undefined\" && __cjs_getProcess$1.versions && __cjs_getProcess$1.versions.node) {\n    const [major, minor] = __cjs_getProcess$1.versions.node.split(\".\").map(Number);\n    if (major > 22 || major === 22 && minor >= 3 || major === 20 && minor >= 16) {\n      return __cjs_getProcess$1.getBuiltinModule(module);\n    }\n  }\n  return __cjs_require$1(module);\n};\nconst {\n  unlink: unlink$1,\n  rm\n} = __cjs_getBuiltinModule$1(\"node:fs/promises\");\nconst remove = async (path, options = {}) => {\n  assertValidFileOrDirectoryPath(path);\n  try {\n    await unlink$1(path);\n  } catch {\n  }\n  try {\n    await rm(path, { force: true, maxRetries: options?.maxRetries, recursive: true, retryDelay: options?.retryDelay });\n  } catch {\n  }\n};\n\nconst assertValidFileContents = (contents) => {\n  if (typeof contents !== \"string\" && !(contents instanceof ArrayBuffer) && !ArrayBuffer.isView(contents)) {\n    throw new TypeError(\"File contents must be a string, ArrayBuffer, or ArrayBuffer view.\");\n  }\n};\n\nconst encoder = new TextEncoder();\nconst toUint8Array = (contents) => {\n  if (contents instanceof Uint8Array) {\n    return contents;\n  }\n  if (typeof contents === \"string\") {\n    return encoder.encode(contents);\n  }\n  if (contents instanceof ArrayBuffer) {\n    return new Uint8Array(contents);\n  }\n  if (ArrayBuffer.isView(contents)) {\n    const bytes = contents.buffer.slice(contents.byteOffset, contents.byteOffset + contents.byteLength);\n    return new Uint8Array(bytes);\n  }\n  throw new TypeError(\"Invalid contents type. Expected string or ArrayBuffer.\");\n};\n\nconst __cjs_require = createRequire(import.meta.url);\nconst __cjs_getProcess = typeof globalThis !== \"undefined\" && typeof globalThis.process !== \"undefined\" ? globalThis.process : process;\nconst __cjs_getBuiltinModule = (module) => {\n  if (typeof __cjs_getProcess !== \"undefined\" && __cjs_getProcess.versions && __cjs_getProcess.versions.node) {\n    const [major, minor] = __cjs_getProcess.versions.node.split(\".\").map(Number);\n    if (major > 22 || major === 22 && minor >= 3 || major === 20 && minor >= 16) {\n      return __cjs_getProcess.getBuiltinModule(module);\n    }\n  }\n  return __cjs_require(module);\n};\nconst {\n  mkdir,\n  writeFile: writeFile$1,\n  stat,\n  rename,\n  chown,\n  chmod,\n  unlink\n} = __cjs_getBuiltinModule(\"node:fs/promises\");\nconst writeFile = async (path, content, options) => {\n  options = {\n    encoding: \"utf8\",\n    flag: \"w\",\n    overwrite: true,\n    recursive: true,\n    ...options\n  };\n  assertValidFileOrDirectoryPath(path);\n  assertValidFileContents(content);\n  path = toPath(path);\n  const temporaryPath = `${path}.tmp`;\n  try {\n    const pathExists = await isAccessible(path, F_OK);\n    if (!pathExists && options.recursive) {\n      const directory = dirname(path);\n      if (!await isAccessible(directory, F_OK)) {\n        await mkdir(directory, { recursive: true });\n      }\n    }\n    let stat$1;\n    await writeFile$1(temporaryPath, toUint8Array(content), { encoding: options.encoding, flag: options.flag });\n    if (pathExists && !options.overwrite) {\n      stat$1 = await stat(path);\n      if (options.chown === void 0) {\n        options.chown = { gid: stat$1.gid, uid: stat$1.uid };\n      }\n      await rename(path, `${path}.bak`);\n    }\n    if (options.chown) {\n      try {\n        await chown(temporaryPath, options.chown.uid, options.chown.gid);\n      } catch {\n      }\n    }\n    await chmod(temporaryPath, stat$1 && !options.mode ? stat$1.mode : options.mode ?? 438);\n    await rename(temporaryPath, path);\n  } catch (error) {\n    throw new Error(`Failed to write file at: ${path} - ${error.message}`, { cause: error });\n  } finally {\n    if (await isAccessible(temporaryPath)) {\n      await unlink(`${path}.tmp`);\n    }\n  }\n};\n\nclass LocalMetaStorage extends MetaStorage {\n  directory;\n  constructor(config) {\n    super(config);\n    this.directory = normalize(config?.directory || join(tmpdir(), \"Upload_meta\"));\n    this.accessCheck().catch((error) => {\n      this.logger?.error(\"Metadata storage access check failed: %O\", error);\n    });\n  }\n  /**\n   * Returns metafile path.\n   * @param id upload id\n   */\n  getMetaPath = (id) => normalize(`${this.directory}/${this.prefix}${id}${this.suffix}`);\n  /**\n   * Returns upload id from metafile path.\n   * @internal\n   */\n  getIdFromPath = (metaFilePath) => metaFilePath.slice(`${this.directory}/${this.prefix}`.length, -this.suffix.length);\n  async save(id, file) {\n    await this.accessCheck();\n    const transformedMetadata = { ...file };\n    if (transformedMetadata.metadata) {\n      transformedMetadata.metadata = stringifyMetadata(file.metadata);\n    }\n    await writeFile(this.getMetaPath(id), JSON.stringify(transformedMetadata), {\n      recursive: true\n    });\n    return file;\n  }\n  async touch(id, file) {\n    const time = /* @__PURE__ */ new Date();\n    await utimes(this.getMetaPath(id), time, time);\n    return file;\n  }\n  async get(id) {\n    try {\n      const json = await readFile(this.getMetaPath(id));\n      if (json === void 0) {\n        throw new TypeError(\"Invalid metafile\");\n      }\n      const file = JSON.parse(json);\n      if (file.metadata && typeof file.metadata === \"string\") {\n        file.metadata = parseMetadata(file.metadata);\n      }\n      return file;\n    } catch (error) {\n      if (error instanceof Error && error.message.includes(\"ENOENT\")) {\n        throw throwErrorCode(ERRORS.FILE_NOT_FOUND);\n      }\n      throw error;\n    }\n  }\n  async delete(id) {\n    await remove(this.getMetaPath(id));\n  }\n  async accessCheck() {\n    await ensureDir(this.directory);\n  }\n}\n\nexport { LocalMetaStorage as L, assertValidFileOrDirectoryPath as a, readFile as b, ensureDir as e, getFileInfoType as g, isAccessible as i, remove as r, toPath as t };\n"],"names":[],"mappings":"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ACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACD,OAAO;AACT;AACA,IAAI,0BAA0B,aAAa,GAAG;AAC9C,MAAM,mBAAmB,aAAa,GAAG,wBAAwB;AACjE,IAAI,IAAI;AACR,MAAM,SAAS,CAAC,YAAc,IAAA,sLAAoB,EAAC,qBAAqB,MAAM,cAAc,aAAa;AAEzG,MAAM,kBAAkB,IAAA,sIAAa,EAAC,8BAAY,GAAG;AACrD,MAAM,qBAAqB,OAAO,eAAe,eAAe,OAAO,WAAW,OAAO,KAAK,cAAc,WAAW,OAAO,GAAG;AACjI,MAAM,2BAA2B,CAAC;IAC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"}},
    {"offset": {"line": 2824, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage/dist/packem_shared/File-Bb3P23dr.js"],"sourcesContent":["import fnv1a from '@sindresorhus/fnv1a';\nimport { nanoid } from 'nanoid';\n\nconst hash = (value) => fnv1a(value, { size: 64 }).toString(16);\nconst extractMimeType = (meta) => {\n  if (typeof meta.mimeType === \"string\") {\n    return meta.mimeType;\n  }\n  if (typeof meta.type === \"string\") {\n    return meta.type;\n  }\n  if (typeof meta.filetype === \"string\") {\n    return meta.filetype;\n  }\n  return void 0;\n};\nconst extractOriginalName = (meta) => {\n  if (typeof meta.name === \"string\") {\n    return meta.name;\n  }\n  if (typeof meta.title === \"string\") {\n    return meta.title;\n  }\n  if (typeof meta.originalName === \"string\") {\n    return meta.originalName;\n  }\n  if (typeof meta.filename === \"string\") {\n    return meta.filename;\n  }\n  return void 0;\n};\nconst generateFileId = (file) => {\n  const { metadata, originalName, size } = file;\n  const mtime = String(metadata.lastModified ?? Date.now());\n  return [originalName, size, mtime].filter(Boolean).map(String).map((value) => hash(value)).join(\"-\");\n};\nclass File {\n  bytesWritten = Number.NaN;\n  contentType;\n  originalName;\n  id;\n  metadata;\n  name = \"\";\n  size;\n  status;\n  expiredAt;\n  createdAt;\n  modifiedAt;\n  hash;\n  content;\n  ETag;\n  constructor({ contentType, expiredAt, metadata = {}, originalName, size }) {\n    this.metadata = metadata;\n    this.originalName = originalName || extractOriginalName(metadata) || (this.id = nanoid());\n    this.contentType = contentType || extractMimeType(metadata) || \"application/octet-stream\";\n    this.expiredAt = expiredAt;\n    if (typeof size === \"string\" || typeof size === \"number\") {\n      this.size = Number(size);\n    } else if (typeof metadata.size === \"string\" || typeof metadata.size === \"number\") {\n      this.size = Number(metadata.size);\n    }\n    if (typeof this.size === \"number\" && this.size <= 0) {\n      this.size = void 0;\n    }\n    this.id ||= generateFileId(this);\n  }\n}\n\nexport { File as default };\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM,OAAO,CAAC,QAAU,IAAA,iOAAK,EAAC,OAAO;QAAE,MAAM;IAAG,GAAG,QAAQ,CAAC;AAC5D,MAAM,kBAAkB,CAAC;IACvB,IAAI,OAAO,KAAK,QAAQ,KAAK,UAAU;QACrC,OAAO,KAAK,QAAQ;IACtB;IACA,IAAI,OAAO,KAAK,IAAI,KAAK,UAAU;QACjC,OAAO,KAAK,IAAI;IAClB;IACA,IAAI,OAAO,KAAK,QAAQ,KAAK,UAAU;QACrC,OAAO,KAAK,QAAQ;IACtB;IACA,OAAO,KAAK;AACd;AACA,MAAM,sBAAsB,CAAC;IAC3B,IAAI,OAAO,KAAK,IAAI,KAAK,UAAU;QACjC,OAAO,KAAK,IAAI;IAClB;IACA,IAAI,OAAO,KAAK,KAAK,KAAK,UAAU;QAClC,OAAO,KAAK,KAAK;IACnB;IACA,IAAI,OAAO,KAAK,YAAY,KAAK,UAAU;QACzC,OAAO,KAAK,YAAY;IAC1B;IACA,IAAI,OAAO,KAAK,QAAQ,KAAK,UAAU;QACrC,OAAO,KAAK,QAAQ;IACtB;IACA,OAAO,KAAK;AACd;AACA,MAAM,iBAAiB,CAAC;IACtB,MAAM,EAAE,QAAQ,EAAE,YAAY,EAAE,IAAI,EAAE,GAAG;IACzC,MAAM,QAAQ,OAAO,SAAS,YAAY,IAAI,KAAK,GAAG;IACtD,OAAO;QAAC;QAAc;QAAM;KAAM,CAAC,MAAM,CAAC,SAAS,GAAG,CAAC,QAAQ,GAAG,CAAC,CAAC,QAAU,KAAK,QAAQ,IAAI,CAAC;AAClG;AACA,MAAM;IACJ,eAAe,OAAO,GAAG,CAAC;IAC1B,YAAY;IACZ,aAAa;IACb,GAAG;IACH,SAAS;IACT,OAAO,GAAG;IACV,KAAK;IACL,OAAO;IACP,UAAU;IACV,UAAU;IACV,WAAW;IACX,KAAK;IACL,QAAQ;IACR,KAAK;IACL,YAAY,EAAE,WAAW,EAAE,SAAS,EAAE,WAAW,CAAC,CAAC,EAAE,YAAY,EAAE,IAAI,EAAE,CAAE;QACzE,IAAI,CAAC,QAAQ,GAAG;QAChB,IAAI,CAAC,YAAY,GAAG,gBAAgB,oBAAoB,aAAa,CAAC,IAAI,CAAC,EAAE,GAAG,IAAA,8MAAM,GAAE;QACxF,IAAI,CAAC,WAAW,GAAG,eAAe,gBAAgB,aAAa;QAC/D,IAAI,CAAC,SAAS,GAAG;QACjB,IAAI,OAAO,SAAS,YAAY,OAAO,SAAS,UAAU;YACxD,IAAI,CAAC,IAAI,GAAG,OAAO;QACrB,OAAO,IAAI,OAAO,SAAS,IAAI,KAAK,YAAY,OAAO,SAAS,IAAI,KAAK,UAAU;YACjF,IAAI,CAAC,IAAI,GAAG,OAAO,SAAS,IAAI;QAClC;QACA,IAAI,OAAO,IAAI,CAAC,IAAI,KAAK,YAAY,IAAI,CAAC,IAAI,IAAI,GAAG;YACnD,IAAI,CAAC,IAAI,GAAG,KAAK;QACnB;QACA,IAAI,CAAC,EAAE,KAAK,eAAe,IAAI;IACjC;AACF"}},
    {"offset": {"line": 2907, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage/dist/packem_shared/update-size-CCGm6i1J.js"],"sourcesContent":["const updateSize = (file, size) => {\n  if (size < file.size) {\n    file.size = size;\n  }\n  return file;\n};\n\nexport { updateSize as u };\n"],"names":[],"mappings":";;;;AAAA,MAAM,aAAa,CAAC,MAAM;IACxB,IAAI,OAAO,KAAK,IAAI,EAAE;QACpB,KAAK,IAAI,GAAG;IACd;IACA,OAAO;AACT"}},
    {"offset": {"line": 2922, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage/dist/packem_shared/has-content-CY66ehMK.js"],"sourcesContent":["const hasContent = (part) => typeof part.start === \"number\" && part.start >= 0 && !!part.body;\n\nexport { hasContent as h };\n"],"names":[],"mappings":";;;;AAAA,MAAM,aAAa,CAAC,OAAS,OAAO,KAAK,KAAK,KAAK,YAAY,KAAK,KAAK,IAAI,KAAK,CAAC,CAAC,KAAK,IAAI"}},
    {"offset": {"line": 2932, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage/dist/packem_shared/disk-storage-Bnldtwqx.js"],"sourcesContent":["import { createReadStream, createWriteStream } from 'node:fs';\nimport { truncate, copyFile as copyFile$1, stat as stat$1 } from 'node:fs/promises';\nimport { PassThrough, Transform, pipeline } from 'node:stream';\nimport { g as getDefaultExportFromCjs } from './_commonjsHelpers-B85MJLTf.js';\nimport require$$0 from 'crypto';\nimport require$$1 from 'fs';\nimport { g as getFileStatus, p as partMatch, d as detectFileTypeFromStream } from './part-match-CW8Z1naC.js';\nimport { throwErrorCode, ERRORS } from './ERRORS-DKaR93nv.js';\nimport { createHash } from 'node:crypto';\nimport { B as BaseStorage, a as defaultFilesystemFileNameValidation, t as toMilliseconds } from './storage-qBIeShej.js';\nimport { a as assertValidFileOrDirectoryPath, g as getFileInfoType, e as ensureDir, t as toPath, i as isAccessible, L as LocalMetaStorage, b as readFile, r as remove } from './local-meta-storage-CsuVst9V.js';\nimport File from './File-Bb3P23dr.js';\nimport { createRequire } from 'node:module';\nimport { d as dirname, r as resolve, j as join, n as normalize, b as basename, i as isAbsolute } from './path-CR6YkPXX-7R1-9CMk.js';\nimport { u as updateSize } from './update-size-CCGm6i1J.js';\nimport { h as hasContent } from './has-content-CY66ehMK.js';\n\nconst __cjs_require$2 = createRequire(import.meta.url);\nconst __cjs_getProcess$2 = typeof globalThis !== \"undefined\" && typeof globalThis.process !== \"undefined\" ? globalThis.process : process;\nconst __cjs_getBuiltinModule$2 = (module) => {\n  if (typeof __cjs_getProcess$2 !== \"undefined\" && __cjs_getProcess$2.versions && __cjs_getProcess$2.versions.node) {\n    const [major, minor] = __cjs_getProcess$2.versions.node.split(\".\").map(Number);\n    if (major > 22 || major === 22 && minor >= 3 || major === 20 && minor >= 16) {\n      return __cjs_getProcess$2.getBuiltinModule(module);\n    }\n  }\n  return __cjs_require$2(module);\n};\nconst {\n  lstat,\n  writeFile\n} = __cjs_getBuiltinModule$2(\"node:fs/promises\");\nconst ensureFile = async (filePath) => {\n  assertValidFileOrDirectoryPath(filePath);\n  try {\n    const stat = await lstat(filePath);\n    if (!stat.isFile()) {\n      throw new Error(`Ensure path exists, expected 'file', got '${getFileInfoType(stat)}'`);\n    }\n  } catch (error) {\n    if (error.code === \"ENOENT\") {\n      await ensureDir(dirname(toPath(filePath)));\n      await writeFile(filePath, new Uint8Array());\n      return;\n    }\n    throw error;\n  }\n};\n\nclass WalkError extends Error {\n  /** File path of the root that's being walked. */\n  root;\n  /**\n   * Constructs a new instance.\n   * @param cause The underlying error or reason for the walk failure.\n   * @param root The root directory path where the walk operation started or encountered the error.\n   */\n  constructor(cause, root) {\n    super(`${cause instanceof Error ? cause.message : cause} for path \"${root}\"`);\n    this.cause = cause;\n    this.root = root;\n  }\n  // eslint-disable-next-line class-methods-use-this\n  get name() {\n    return \"WalkError\";\n  }\n  // eslint-disable-next-line class-methods-use-this,@typescript-eslint/explicit-module-boundary-types\n  set name(_name) {\n    throw new Error(\"Cannot overwrite name of WalkError\");\n  }\n}\n\nconst globToRegExp = (glob) => {\n  const reString = glob.replace(/\\.\\*/g, \".([^/]*)\").replace(/\\*\\*/g, \"(.*)\").replace(/(?<!\\.)\\*(?!\\*)/g, \"([^/]*)\").replace(/\\?/g, \"[^/]\").replace(/\\.(?!\\*)/g, String.raw`\\.`).replace(/\\{/g, \"(\").replace(/\\}/g, \")\").replace(/,/g, \"|\").replace(/\\[!(.*?)\\]/g, \"[^$1]\");\n  return new RegExp(`^${reString}$`);\n};\nconst walkInclude = (path, extensions, match, skip) => {\n  if (Array.isArray(extensions) && extensions.length > 0 && !extensions.some((extension) => path.endsWith(extension))) {\n    return false;\n  }\n  if (match && !match.some((pattern) => pattern.test(path))) {\n    return false;\n  }\n  return !skip?.some((pattern) => pattern.test(path));\n};\n\nconst __cjs_require$1 = createRequire(import.meta.url);\nconst __cjs_getProcess$1 = typeof globalThis !== \"undefined\" && typeof globalThis.process !== \"undefined\" ? globalThis.process : process;\nconst __cjs_getBuiltinModule$1 = (module) => {\n  if (typeof __cjs_getProcess$1 !== \"undefined\" && __cjs_getProcess$1.versions && __cjs_getProcess$1.versions.node) {\n    const [major, minor] = __cjs_getProcess$1.versions.node.split(\".\").map(Number);\n    if (major > 22 || major === 22 && minor >= 3 || major === 20 && minor >= 16) {\n      return __cjs_getProcess$1.getBuiltinModule(module);\n    }\n  }\n  return __cjs_require$1(module);\n};\nconst {\n  readdir,\n  realpath,\n  stat\n} = __cjs_getBuiltinModule$1(\"node:fs/promises\");\nconst _createWalkEntry = async (path) => {\n  const normalizePath = normalize(path);\n  const name = basename(normalizePath);\n  const info = await stat(normalizePath);\n  return {\n    isDirectory: () => info.isDirectory(),\n    isFile: () => info.isFile(),\n    isSymbolicLink: () => info.isSymbolicLink(),\n    name,\n    path: normalizePath\n  };\n};\nasync function* walk(directory, {\n  extensions,\n  followSymlinks = false,\n  includeDirs: includeDirectories = true,\n  includeFiles = true,\n  includeSymlinks = true,\n  match,\n  maxDepth = Number.POSITIVE_INFINITY,\n  skip\n} = {}) {\n  assertValidFileOrDirectoryPath(directory);\n  if (maxDepth < 0) {\n    return;\n  }\n  const mappedMatch = match ? match.map((pattern) => typeof pattern === \"string\" ? globToRegExp(pattern) : pattern) : void 0;\n  const mappedSkip = skip ? skip.map((pattern) => typeof pattern === \"string\" ? globToRegExp(pattern) : pattern) : void 0;\n  directory = resolve(toPath(directory));\n  if (includeDirectories && walkInclude(directory, extensions, mappedMatch, mappedSkip)) {\n    yield await _createWalkEntry(directory);\n  }\n  if (maxDepth < 1 || !walkInclude(directory, void 0, void 0, mappedSkip)) {\n    return;\n  }\n  try {\n    for await (const entry of await readdir(directory, {\n      withFileTypes: true\n    })) {\n      let path = join(directory, entry.name);\n      if (entry.isSymbolicLink()) {\n        if (followSymlinks) {\n          path = await realpath(path);\n        } else if (includeSymlinks && walkInclude(path, extensions, mappedMatch, mappedSkip)) {\n          yield {\n            isDirectory: entry.isDirectory,\n            isFile: entry.isFile,\n            isSymbolicLink: entry.isSymbolicLink,\n            name: entry.name,\n            path\n          };\n        } else {\n          continue;\n        }\n      }\n      if (entry.isSymbolicLink() || entry.isDirectory()) {\n        yield* walk(path, {\n          extensions,\n          followSymlinks,\n          includeDirs: includeDirectories,\n          includeFiles,\n          includeSymlinks,\n          match: mappedMatch,\n          maxDepth: maxDepth - 1,\n          skip: mappedSkip\n        });\n      } else if (entry.isFile() && includeFiles && walkInclude(path, extensions, mappedMatch, mappedSkip)) {\n        yield {\n          isDirectory: () => entry.isDirectory(),\n          isFile: () => entry.isFile(),\n          isSymbolicLink: () => entry.isSymbolicLink(),\n          name: entry.name,\n          path\n        };\n      }\n    }\n  } catch (error) {\n    if (error instanceof WalkError) {\n      throw error;\n    }\n    throw new WalkError(error, directory);\n  }\n}\n\nconst __cjs_require = createRequire(import.meta.url);\nconst __cjs_getProcess = typeof globalThis !== \"undefined\" && typeof globalThis.process !== \"undefined\" ? globalThis.process : process;\nconst __cjs_getBuiltinModule = (module) => {\n  if (typeof __cjs_getProcess !== \"undefined\" && __cjs_getProcess.versions && __cjs_getProcess.versions.node) {\n    const [major, minor] = __cjs_getProcess.versions.node.split(\".\").map(Number);\n    if (major > 22 || major === 22 && minor >= 3 || major === 20 && minor >= 16) {\n      return __cjs_getProcess.getBuiltinModule(module);\n    }\n  }\n  return __cjs_require(module);\n};\nconst {\n  cwd\n} = __cjs_getProcess;\nconst {\n  mkdir,\n  rename: rename$1,\n  copyFile,\n  unlink\n} = __cjs_getBuiltinModule(\"node:fs/promises\");\n__cjs_getBuiltinModule(\"node:fs\");\nclass SameDirectoryError extends Error {\n  constructor(source, destination) {\n    super(`Source directory \"${dirname(source)}\" does not match destination directory \"${dirname(destination)}\"`);\n    this.name = \"SameDirectoryError\";\n  }\n}\nconst validateSameDirectory = (source, destination) => {\n  if (!source || !destination) {\n    throw new Error(\"Source and destination paths must not be empty\");\n  }\n  if (dirname(source) !== dirname(destination)) {\n    throw new SameDirectoryError(source, destination);\n  }\n};\nconst internalMoveFile = async (sourcePath, destinationPath, { cwd: cwd2, directoryMode, overwrite, validateDirectory }) => {\n  if (cwd2) {\n    sourcePath = resolve(cwd2, sourcePath);\n    destinationPath = resolve(cwd2, destinationPath);\n  }\n  if (validateDirectory) {\n    validateSameDirectory(sourcePath, destinationPath);\n  }\n  if (!overwrite && await isAccessible(destinationPath)) {\n    throw new Error(`The destination file exists: ${destinationPath}`);\n  }\n  await mkdir(dirname(destinationPath), {\n    mode: directoryMode,\n    recursive: true\n  });\n  try {\n    await rename$1(sourcePath, destinationPath);\n  } catch (error) {\n    if (error.code === \"EXDEV\") {\n      await copyFile(sourcePath, destinationPath);\n      await unlink(sourcePath);\n    } else {\n      throw error;\n    }\n  }\n};\nconst move = async (sourcePath, destinationPath, options = {}) => {\n  const internalOptions = {\n    overwrite: true,\n    validateDirectory: false,\n    ...options,\n    cwd: options.cwd ? toPath(options.cwd) : cwd()\n  };\n  await internalMoveFile(sourcePath, destinationPath, internalOptions);\n};\n\nvar etag_1;\nvar hasRequiredEtag;\n\nfunction requireEtag () {\n\tif (hasRequiredEtag) return etag_1;\n\thasRequiredEtag = 1;\n\t/*!\n\t * etag\n\t * Copyright(c) 2014-2016 Douglas Christopher Wilson\n\t * MIT Licensed\n\t */\n\tetag_1 = etag;\n\tvar crypto = require$$0;\n\tvar Stats = require$$1.Stats;\n\tvar toString = Object.prototype.toString;\n\tfunction entitytag(entity) {\n\t  if (entity.length === 0) {\n\t    return '\"0-2jmj7l5rSw0yVb/vlWAYkK/YBwk\"';\n\t  }\n\t  var hash = crypto.createHash(\"sha1\").update(entity, \"utf8\").digest(\"base64\").substring(0, 27);\n\t  var len = typeof entity === \"string\" ? Buffer.byteLength(entity, \"utf8\") : entity.length;\n\t  return '\"' + len.toString(16) + \"-\" + hash + '\"';\n\t}\n\tfunction etag(entity, options) {\n\t  if (entity == null) {\n\t    throw new TypeError(\"argument entity is required\");\n\t  }\n\t  var isStats = isstats(entity);\n\t  var weak = options && typeof options.weak === \"boolean\" ? options.weak : isStats;\n\t  if (!isStats && typeof entity !== \"string\" && !Buffer.isBuffer(entity)) {\n\t    throw new TypeError(\"argument entity must be string, Buffer, or fs.Stats\");\n\t  }\n\t  var tag = isStats ? stattag(entity) : entitytag(entity);\n\t  return weak ? \"W/\" + tag : tag;\n\t}\n\tfunction isstats(obj) {\n\t  if (typeof Stats === \"function\" && obj instanceof Stats) {\n\t    return true;\n\t  }\n\t  return obj && typeof obj === \"object\" && \"ctime\" in obj && toString.call(obj.ctime) === \"[object Date]\" && \"mtime\" in obj && toString.call(obj.mtime) === \"[object Date]\" && \"ino\" in obj && typeof obj.ino === \"number\" && \"size\" in obj && typeof obj.size === \"number\";\n\t}\n\tfunction stattag(stat) {\n\t  var mtime = stat.mtime.getTime().toString(16);\n\t  var size = stat.size.toString(16);\n\t  return '\"' + size + \"-\" + mtime + '\"';\n\t}\n\treturn etag_1;\n}\n\nvar etagExports = requireEtag();\nconst etag = /*@__PURE__*/getDefaultExportFromCjs(etagExports);\n\nclass StreamChecksum extends Transform {\n  /**\n   * Creates a new StreamChecksum transform stream.\n   * @param checksum Expected checksum value to validate against\n   * @param algorithm Hash algorithm to use (e.g., 'md5', 'sha256')\n   * @param encoding Encoding for the checksum comparison (defaults to 'base64')\n   */\n  constructor(checksum, algorithm, encoding = \"base64\") {\n    super();\n    this.checksum = checksum;\n    this.algorithm = algorithm;\n    this.encoding = encoding;\n    this.hash = createHash(algorithm);\n  }\n  length = 0;\n  digest = \"\";\n  hash;\n  /**\n   * Gets the calculated digest value after the stream has finished processing.\n   * @returns The digest value in the configured encoding, or empty string if not yet calculated\n   */\n  get calculatedDigest() {\n    return this.digest;\n  }\n  /**\n   * Transform method that updates the hash with incoming data.\n   * @param chunk Buffer chunk to process\n   * @param _encoding Unused encoding parameter\n   * @param done Callback to signal completion\n   */\n  // eslint-disable-next-line no-underscore-dangle\n  _transform(chunk, _encoding, done) {\n    this.push(chunk);\n    this.hash.update(chunk);\n    this.length += chunk.length;\n    done();\n  }\n  /**\n   * Finalization method that validates the checksum.\n   * @param callback Callback called with error if checksum validation fails\n   */\n  // eslint-disable-next-line no-underscore-dangle\n  _flush(callback) {\n    this.digest = this.hash.digest(this.encoding);\n    if (this.checksum && this.checksum !== this.digest) {\n      callback(new Error(\"Checksum mismatch\"));\n    } else {\n      callback();\n    }\n  }\n}\nconst streamChecksum = (checksum, algorithm, encoding = \"base64\") => algorithm ? new StreamChecksum(checksum, algorithm, encoding) : new PassThrough();\n\nclass StreamLength extends Transform {\n  /**\n   * Creates a new StreamLength transform stream.\n   * @param limit Maximum number of bytes allowed (defaults to infinity)\n   */\n  constructor(limit = Number.POSITIVE_INFINITY) {\n    super();\n    this.limit = limit;\n  }\n  length = 0;\n  /**\n   * Transform method that counts bytes and enforces size limits.\n   * @param chunk Buffer chunk to process\n   * @param _encoding Unused encoding parameter\n   * @param callback Callback called with error if limit exceeded\n   */\n  // eslint-disable-next-line no-underscore-dangle\n  _transform(chunk, _encoding, callback) {\n    const expected = this.length + chunk.length;\n    if (this.limit >= expected) {\n      this.push(chunk);\n      this.length = expected;\n      callback();\n    } else {\n      callback(new Error(\"Stream length limit exceeded\"));\n    }\n  }\n}\n\nclass DiskStorage extends BaseStorage {\n  static name = \"disk\";\n  checksumTypes = [\"md5\", \"sha1\"];\n  directory;\n  meta;\n  constructor(config) {\n    super(config);\n    this.directory = config.directory;\n    if (config.metaStorage) {\n      this.meta = config.metaStorage;\n    } else {\n      const metaConfig = { ...config, ...config.metaStorageConfig, logger: this.logger };\n      this.meta = new LocalMetaStorage(metaConfig);\n    }\n    if (!config.fileNameValidation) {\n      config.fileNameValidation = defaultFilesystemFileNameValidation;\n    }\n    this.isReady = false;\n    this.accessCheck().then(() => {\n      this.isReady = true;\n    }).catch((error) => {\n      this.logger?.error(\"Storage access check failed: %O\", error);\n    });\n  }\n  /**\n   * Normalizes errors with disk storage context.\n   * @param error The error to normalize.\n   * @returns Normalized HTTP error.\n   */\n  normalizeError(error) {\n    return super.normalizeError(error);\n  }\n  /**\n   * Creates a new file upload and saves its metadata.\n   * @param fileInit File initialization configuration.\n   * @returns Promise resolving to the created file object.\n   * @throws {Error} If validation fails or file already exists and is completed.\n   * @remarks\n   * Supports TTL (time-to-live) option in fileInit.\n   * Creates the file on disk if it doesn't exist.\n   * Returns existing file if it's already completed.\n   */\n  async create(fileInit) {\n    return this.instrumentOperation(\"create\", async () => {\n      const processedConfig = { ...fileInit };\n      if (fileInit.ttl) {\n        const ttlMs = typeof fileInit.ttl === \"string\" ? toMilliseconds(fileInit.ttl) : fileInit.ttl;\n        if (ttlMs !== void 0) {\n          processedConfig.expiredAt = Date.now() + ttlMs;\n        }\n      }\n      if (processedConfig.size !== void 0 && Number(processedConfig.size) < 0) {\n        throwErrorCode(ERRORS.REQUEST_ENTITY_TOO_LARGE, \"Request entity too large\");\n      }\n      const file = new File(processedConfig);\n      try {\n        const existing = await this.getMeta(file.id);\n        if (existing.status === \"completed\") {\n          return existing;\n        }\n      } catch {\n      }\n      file.name = this.namingFunction(file);\n      if (file.size === void 0 || Number.isNaN(file.size)) {\n        if (file.size === void 0) ; else {\n          file.size = this.maxUploadSize;\n        }\n      }\n      await this.validate(file);\n      const path = this.getFilePath(file.name);\n      try {\n        await ensureFile(path);\n        file.bytesWritten = 0;\n      } catch (error) {\n        const message = error instanceof Error ? error.message : String(error);\n        throwErrorCode(ERRORS.FILE_ERROR, message);\n      }\n      file.status = getFileStatus(file);\n      await this.saveMeta(file);\n      await this.onCreate(file);\n      return file;\n    });\n  }\n  /**\n   * Writes data to a file upload.\n   * @param part File part containing data to write, file query, or full file object.\n   * @returns Promise resolving to the updated file object.\n   * @throws {Error} If file is expired (ERRORS.GONE), locked (ERRORS.FILE_LOCKED), or conflicts occur (ERRORS.FILE_CONFLICT).\n   * @remarks\n   * Supports chunked uploads with start position.\n   * Automatically detects file type from stream on first chunk if contentType is not set.\n   * Validates checksum algorithms if provided.\n   * Uses file locking to prevent concurrent writes.\n   * Updates file status to \"completed\" when all bytes are written.\n   */\n  async write(part) {\n    return this.instrumentOperation(\"write\", async () => {\n      let file;\n      const isFullFile = \"contentType\" in part && \"metadata\" in part && !(\"body\" in part) && !(\"start\" in part);\n      if (isFullFile) {\n        file = part;\n      } else {\n        file = await this.getMeta(part.id);\n        await this.checkIfExpired(file);\n      }\n      if (file.status === \"completed\") {\n        return file;\n      }\n      if (part.size !== void 0) {\n        updateSize(file, part.size);\n      }\n      if (!partMatch(part, file)) {\n        return throwErrorCode(ERRORS.FILE_CONFLICT);\n      }\n      const path = this.getFilePath(file.name);\n      await this.lock(path);\n      try {\n        const startPosition = part.start || 0;\n        await ensureFile(path);\n        if (file.bytesWritten === 0) {\n          file.bytesWritten = startPosition;\n        }\n        if (hasContent(part)) {\n          if (this.isUnsupportedChecksum(part.checksumAlgorithm)) {\n            return throwErrorCode(ERRORS.UNSUPPORTED_CHECKSUM_ALGORITHM);\n          }\n          const isFirstChunk = part.start === 0 || part.start === void 0;\n          if (isFirstChunk && (file.bytesWritten === 0 || Number.isNaN(file.bytesWritten)) && (!file.contentType || file.contentType === \"application/octet-stream\")) {\n            try {\n              const { fileType, stream: detectedStream } = await detectFileTypeFromStream(part.body);\n              if (fileType?.mime) {\n                file.contentType = fileType.mime;\n              }\n              part.body = detectedStream;\n            } catch {\n            }\n          }\n          const signalFromPart = part.signal;\n          const lazyWritePart = { ...file, ...part, body: part.body };\n          if (signalFromPart) {\n            lazyWritePart.signal = signalFromPart;\n          }\n          const [bytesWritten, errorCode] = await this.lazyWrite(lazyWritePart);\n          if (errorCode) {\n            await truncate(path, file.bytesWritten);\n            return throwErrorCode(errorCode);\n          }\n          const expectedBytesWritten = startPosition + (part.contentLength || 0);\n          file.bytesWritten = Math.max(file.bytesWritten || 0, expectedBytesWritten);\n          file.bytesWritten = Math.max(file.bytesWritten || 0, bytesWritten);\n          file.status = getFileStatus(file);\n          await this.saveMeta(file);\n        } else {\n          await ensureFile(path);\n          file.bytesWritten = 0;\n        }\n        return file;\n      } catch (error) {\n        const message = error instanceof Error ? error.message : String(error);\n        return throwErrorCode(ERRORS.FILE_ERROR, message);\n      } finally {\n        await this.unlock(path);\n      }\n    });\n  }\n  /**\n   * Gets an uploaded file by ID.\n   * @param query File query containing the file ID to retrieve.\n   * @param query.id File ID to retrieve.\n   * @returns Promise resolving to the file data including content buffer.\n   * @throws {Error} If the file cannot be found (ERRORS.FILE_NOT_FOUND) or has expired (ERRORS.GONE).\n   * @remarks\n   * Loads the entire file content into memory as a Buffer.\n   * For large files, consider using getStream() instead.\n   * Includes ETag (MD5 hash) for content verification.\n   */\n  async get({ id }) {\n    return this.instrumentOperation(\"get\", async () => {\n      const file = await this.checkIfExpired(await this.meta.get(id));\n      const { bytesWritten, contentType, expiredAt, metadata, modifiedAt, name, originalName, size } = file;\n      let content;\n      try {\n        content = await readFile(this.getFilePath(name), { buffer: true });\n      } catch (error) {\n        const errorWithCode = error;\n        if (errorWithCode.code === \"ENOENT\" || errorWithCode.code === \"EPERM\") {\n          const message = error instanceof Error ? error.message : errorWithCode.message || String(error);\n          return throwErrorCode(ERRORS.FILE_NOT_FOUND, message);\n        }\n        throw error;\n      }\n      return {\n        content,\n        contentType,\n        ETag: etag(content),\n        expiredAt,\n        id,\n        metadata,\n        modifiedAt,\n        name,\n        originalName,\n        size: size || bytesWritten\n      };\n    });\n  }\n  /**\n   * Gets an uploaded file as a readable stream for efficient large file handling.\n   * @param query File query containing the file ID to stream.\n   * @param query.id File ID to stream.\n   * @returns Promise resolving to an object containing the stream, headers, and size.\n   * @throws {UploadError} If the file cannot be found (ERRORS.FILE_NOT_FOUND) or has expired (ERRORS.GONE).\n   * @remarks Creates a readable stream directly from the file system for efficient memory usage.\n   */\n  async getStream({ id }) {\n    return this.instrumentOperation(\"getStream\", async () => {\n      try {\n        const file = await this.checkIfExpired(await this.meta.get(id));\n        const { bytesWritten, contentType, expiredAt, modifiedAt, name, size } = file;\n        const stream = createReadStream(this.getFilePath(name));\n        return {\n          headers: {\n            \"Content-Length\": String(size || bytesWritten),\n            \"Content-Type\": contentType,\n            ...expiredAt && { \"X-Upload-Expires\": expiredAt.toString() },\n            ...modifiedAt && { \"Last-Modified\": modifiedAt.toString() }\n            // Note: ETag requires reading the file content, so we don't include it for streaming\n            // Clients can use HEAD requests to get ETag if needed\n          },\n          size: size || bytesWritten,\n          stream\n        };\n      } catch (error) {\n        const message = error instanceof Error ? error.message : String(error);\n        throw throwErrorCode(ERRORS.FILE_NOT_FOUND, message);\n      }\n    });\n  }\n  /**\n   * Deletes an upload and its metadata.\n   * @param query File query containing the file ID to delete.\n   * @param query.id File ID to delete.\n   * @returns Promise resolving to the deleted file object with status: \"deleted\".\n   * @throws {UploadError} If the file metadata cannot be found.\n   */\n  async delete({ id }) {\n    return this.instrumentOperation(\"delete\", async () => {\n      const file = await this.getMeta(id);\n      await remove(this.getFilePath(file.name));\n      await this.deleteMeta(id);\n      const deletedFile = { ...file, status: \"deleted\" };\n      await this.onDelete(deletedFile);\n      return deletedFile;\n    });\n  }\n  /**\n   * Copies an upload file to a new location.\n   * @param name Source file name/ID.\n   * @param destination Destination file name/ID.\n   * @returns Promise resolving to the copied file object.\n   * @throws {UploadError} If the source file cannot be found.\n   */\n  async copy(name, destination) {\n    return this.instrumentOperation(\"copy\", async () => {\n      const sourceFile = await this.getMeta(name);\n      await copyFile$1(this.getFilePath(sourceFile.name), this.getFilePath(destination));\n      return { ...sourceFile, name: destination };\n    });\n  }\n  /**\n   * Moves an upload file to a new location.\n   * @param name Source file name/ID.\n   * @param destination Destination file name/ID.\n   * @returns Promise resolving to the moved file object.\n   * @throws {Error} If the source file cannot be found.\n   */\n  async move(name, destination) {\n    return this.instrumentOperation(\"move\", async () => {\n      const sourceFile = await this.getMeta(name);\n      const source = this.getFilePath(sourceFile.name);\n      const destinationPath = this.getFilePath(destination);\n      try {\n        await move(source, destinationPath);\n      } catch (error) {\n        const errorWithCode = error;\n        if (errorWithCode?.code === \"EXDEV\") {\n          await copyFile$1(source, destinationPath);\n          await remove(source);\n        } else {\n          throw error;\n        }\n      }\n      return { ...sourceFile, id: sourceFile.id, name: destination };\n    });\n  }\n  /**\n   * Retrieves a list of uploaded files.\n   * @returns Promise resolving to an array of file metadata objects.\n   * @remarks Walks the storage directory and returns all files, excluding metadata files.\n   */\n  async list() {\n    return this.instrumentOperation(\"list\", async () => {\n      const config = {\n        followSymlinks: false,\n        includeDirs: false,\n        includeFiles: true,\n        skip: [\"*.META$\"]\n      };\n      const uploads = [];\n      const { directory } = this;\n      for await (const founding of walk(directory, config)) {\n        const { suffix } = this.meta;\n        const { path } = founding;\n        if (!path.includes(suffix)) {\n          const { birthtime, ctime, mtime } = await stat$1(path);\n          uploads.push({ createdAt: birthtime || ctime, id: path.replace(directory, \"\"), modifiedAt: mtime });\n        }\n      }\n      return uploads;\n    });\n  }\n  /**\n   * Returns path for the uploaded file\n   * If filename is already an absolute path, returns it as-is.\n   * Otherwise, joins it with the storage directory.\n   */\n  getFilePath(filename) {\n    if (isAbsolute(filename)) {\n      return filename;\n    }\n    return join(this.directory, filename);\n  }\n  lazyWrite(part) {\n    return new Promise((resolve, reject) => {\n      const destination = createWriteStream(this.getFilePath(part.name), { flags: \"r+\", start: part.start });\n      const lengthChecker = new StreamLength(part.contentLength || part.size - part.start);\n      const checksumChecker = streamChecksum(part.checksum, part.checksumAlgorithm);\n      const keepPartial = !part.checksum;\n      const { signal } = part;\n      const cleanupStreams = () => {\n        destination.close();\n        lengthChecker.destroy();\n        checksumChecker.destroy();\n      };\n      const failWithCode = (code) => {\n        cleanupStreams();\n        resolve([Number.NaN, code]);\n      };\n      lengthChecker.on(\"error\", () => failWithCode(ERRORS.FILE_CONFLICT));\n      checksumChecker.on(\"error\", () => failWithCode(ERRORS.CHECKSUM_MISMATCH));\n      part.body.on(\"aborted\", () => failWithCode(keepPartial ? void 0 : ERRORS.REQUEST_ABORTED));\n      part.body.on(\"error\", (error) => {\n        cleanupStreams();\n        reject(error);\n      });\n      if (signal?.aborted) {\n        return failWithCode(keepPartial ? void 0 : ERRORS.REQUEST_ABORTED);\n      }\n      if (signal) {\n        signal.addEventListener(\"abort\", () => {\n          cleanupStreams();\n          destination.destroy();\n          lengthChecker.destroy();\n          checksumChecker.destroy();\n          part.body.destroy();\n          resolve([Number.NaN, keepPartial ? void 0 : ERRORS.REQUEST_ABORTED]);\n        });\n      }\n      pipeline(part.body, lengthChecker, checksumChecker, destination, (error) => {\n        if (error) {\n          cleanupStreams();\n          if (signal && signal.aborted) {\n            return resolve([Number.NaN, keepPartial ? void 0 : ERRORS.REQUEST_ABORTED]);\n          }\n          return resolve([Number.NaN, ERRORS.FILE_ERROR]);\n        }\n        return resolve([part.start + destination.bytesWritten]);\n      });\n    });\n  }\n  async accessCheck() {\n    await ensureDir(this.directory);\n  }\n}\n\nexport { DiskStorage as D, StreamLength as S, ensureFile as e, streamChecksum as s };\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3765, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage-client/examples/nextjs/lib/storage.ts"],"sourcesContent":["import { DiskStorage } from \"@visulima/storage\";\nimport { mkdir } from \"node:fs/promises\";\nimport { join } from \"node:path\";\nimport { tmpdir } from \"node:os\";\n\n/**\n * Shared storage instance for file uploads.\n * Uses local disk storage for development.\n */\nconst uploadDirectory = join(tmpdir(), \"uploads\");\n\n// Ensure upload directory exists\nmkdir(uploadDirectory, { recursive: true }).catch((error) => {\n    console.error(\"Failed to create upload directory:\", error);\n});\n\nexport const storage = new DiskStorage({\n    directory: uploadDirectory,\n    maxUploadSize: \"100MB\",\n    logger: console,\n});\n\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEA;;;CAGC,GACD,MAAM,kBAAkB,IAAA,yHAAI,EAAC,IAAA,uHAAM,KAAI;AAEvC,iCAAiC;AACjC,IAAA,8IAAK,EAAC,iBAAiB;IAAE,WAAW;AAAK,GAAG,KAAK,CAAC,CAAC;IAC/C,QAAQ,KAAK,CAAC,sCAAsC;AACxD;AAEO,MAAM,UAAU,IAAI,gOAAW,CAAC;IACnC,WAAW;IACX,eAAe;IACf,QAAQ;AACZ"}},
    {"offset": {"line": 3796, "column": 0}, "map": {"version":3,"sources":["file:///home/prisis/WebstormProjects/visulima/visulima/packages/storage-client/examples/nextjs/app/api/upload/multipart/route.ts"],"sourcesContent":["import { createNextjsHandler } from \"@visulima/storage/handler/http/nextjs\";\nimport { storage } from \"../../../../lib/storage\";\n\nconst handler = createNextjsHandler({ storage, type: \"multipart\" });\n\nexport const POST = handler;\nexport const DELETE = handler;\nexport const GET = handler;\nexport const OPTIONS = handler;\n\n"],"names":[],"mappings":";;;;;;;;;;;;;;;AACA;;;AAEA,MAAM,UAAU,oBAAoB;IAAE,SAAA,kLAAO;IAAE,MAAM;AAAY;AAE1D,MAAM,OAAO;AACb,MAAM,SAAS;AACf,MAAM,MAAM;AACZ,MAAM,UAAU"}}]
}