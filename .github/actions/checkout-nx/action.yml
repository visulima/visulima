name: "Checkout with Nx affected"
description: "Checkout the repository and set the appropriate SHAs for base and head for `nx affected` commands"

env:
    NX_BRANCH: "${{ github.event.number }}"
    NX_RUN_GROUP: "${{ github.run_id }}"
    HEAD_REF: "${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || github.ref_name }}"
    HEAD_REPOSITORY: "${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name || github.repository }}"

runs:
    using: "composite"
    steps:
        - name: "Harden Runner"
          uses: "step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142" # v2.7.0
          with:
              egress-policy: "audit"

        - name: "Git checkout ${{ env.HEAD_REPOSITORY }}:${{ env.HEAD_REF }}"
          uses: "actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11" # v4.1.1
          env:
              GIT_COMMITTER_NAME: "GitHub Actions Shell"
              GIT_AUTHOR_NAME: "GitHub Actions Shell"
              EMAIL: "github-actions[bot]@users.noreply.github.com"
          with:
              # Number of commits to fetch. 0 indicates all history for all branches and tags.
              # Pulls all commits (needed for NX)
              fetch-depth: 0

        - name: "Derive appropriate SHAs for base and head for `nx affected` commands"
          uses: "nrwl/nx-set-shas@v4"
